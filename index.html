<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mikra - Pedidos</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2744">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mikra Pedidos">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #1a2744; --bg-card: #243554; --bg-input: #1e3a5f;
            --primary: #4facfe; --success: #4ade80; --warning: #fbbf24;
            --danger: #f87171; --purple: #a78bfa;
            --text: #ffffff; --text-secondary: #94a3b8; --border: #3b5998;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(180deg, #1a2744 0%, #0f172a 100%);
            color: var(--text); min-height: 100vh; padding-bottom: 70px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* HEADER */
        .header { 
            padding: 10px 16px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: var(--bg-card);
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-title { font-size: 1em; font-weight: 700; color: var(--primary); }
        .sync-inline { display: flex; align-items: center; gap: 5px; font-size: 0.68em; color: var(--text-secondary); }
        .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--success); }
        .sync-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header-right { display: flex; gap: 6px; }
        .icon-btn { 
            background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 4px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* SEARCH */
        .container { max-width: 800px; margin: 0 auto; padding: 8px; }
        .search-container { position: relative; margin-bottom: 8px; }
        .search-box {
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px;
            padding: 10px 14px; display: flex; align-items: center; gap: 10px;
        }
        .search-box input {
            flex: 1; background: none; border: none; color: var(--text); font-size: 16px; outline: none;
        }
        .search-box input::placeholder { color: var(--text-secondary); }
        .search-clear {
            background: var(--danger); border: none; color: white; font-size: 0.85em;
            cursor: pointer; padding: 5px 10px; border-radius: 8px; font-weight: 700; display: none;
        }
        .search-clear.show { display: block; }
        
        .autocomplete {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 0 0 12px 12px; max-height: 300px; overflow-y: auto; z-index: 100; display: none;
        }
        .autocomplete.show { display: block; }
        .autocomplete-item {
            padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .autocomplete-item:hover { background: var(--bg-input); }
        .autocomplete-name { font-weight: 600; font-size: 0.9em; }
        .autocomplete-stock { 
            font-size: 0.78em; color: var(--success);
            background: rgba(74, 222, 128, 0.15); padding: 2px 8px; border-radius: 10px;
        }
        
        /* FILTERS */
        .filter-row { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .filter-chip {
            padding: 5px 10px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 20px; font-size: 0.72em; font-weight: 600; color: var(--text-secondary); cursor: pointer;
        }
        .filter-chip:hover { border-color: var(--primary); color: var(--primary); }
        .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }
        .filter-chip.stock.active { background: var(--success); border-color: var(--success); }
        .filter-chip.low.active { background: var(--warning); border-color: var(--warning); color: #1a2744; }
        .filter-chip.out.active { background: var(--danger); border-color: var(--danger); }
        
        .filters-collapse {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; margin-bottom: 8px; overflow: hidden;
        }
        .filters-header {
            padding: 10px 14px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; font-size: 0.82em; font-weight: 600;
        }
        .filters-header:hover { background: var(--bg-input); }
        .filters-arrow { transition: transform 0.3s; }
        .filters-collapse.open .filters-arrow { transform: rotate(180deg); }
        .filters-body { display: none; padding: 0 14px 14px; }
        .filters-collapse.open .filters-body { display: block; }
        .filter-section-title { font-size: 0.7em; color: var(--text-secondary); margin: 10px 0 6px; text-transform: uppercase; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 5px; }
        .filter-opt {
            padding: 5px 10px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.72em; color: var(--text-secondary); cursor: pointer;
        }
        .filter-opt:hover { border-color: var(--primary); color: var(--primary); }
        .filter-opt.active { background: var(--primary); border-color: var(--primary); color: white; }
        .active-filters { display: flex; gap: 4px; margin-left: 8px; flex-wrap: wrap; }
        .active-filter-tag { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.68em; cursor: pointer; display: inline-flex; align-items: center; gap: 3px; -webkit-tap-highlight-color: transparent; }
        .active-filter-tag:active { opacity: 0.7; }
        .active-filter-tag .tag-x { font-weight: 800; font-size: 0.9em; opacity: 0.8; }
        .clear-all-filters-btn { background: var(--danger); color: white; border: none; padding: 2px 8px; border-radius: 10px; font-size: 0.68em; font-weight: 700; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .clear-all-filters-btn:active { opacity: 0.7; }
        
        .location-search { display: none; margin-bottom: 8px; }
        
        .results-info { font-size: 0.75em; color: var(--text-secondary); padding: 4px 0; }
        .results-info strong { color: var(--primary); }
        
        /* PRODUCT LIST */
        .product-list { display: flex; flex-direction: column; gap: 1px; background: var(--border); border-radius: 10px; overflow: hidden; }
        .color-divider {
            background: var(--bg); padding: 6px 14px; font-size: 0.72em; font-weight: 700;
            color: var(--primary); border-bottom: 2px solid var(--primary);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .product-item {
            background: var(--bg-card); padding: 10px 12px;
            display: flex; justify-content: space-between; align-items: center; gap: 8px;
        }
        .product-item:hover { background: var(--bg-input); }
        .product-item.in-cart { background: rgba(79, 172, 254, 0.12); }
        .product-item.no-stock { opacity: 0.6; }
        
        .product-thumb {
            width: 36px; height: 36px; border-radius: 6px; object-fit: cover;
            background: var(--bg-input); cursor: pointer; flex-shrink: 0;
            border: 1px solid var(--border); display: none;
        }
        .show-images .product-thumb { display: block; }
        .product-thumb-placeholder {
            width: 36px; height: 36px; border-radius: 6px; background: var(--bg-input);
            display: none; align-items: center; justify-content: center; font-size: 0.9em;
            flex-shrink: 0; border: 1px solid var(--border);
        }
        .show-images .product-thumb-placeholder { display: flex; }
        
        .product-info { flex: 1; min-width: 0; }
        .product-meta { font-size: 1em; color: var(--text); font-weight: 700; margin-bottom: 2px; }
        .product-sku { font-size: 0.72em; color: var(--text-secondary); opacity: 0.85; }
        .product-name { 
            font-weight: 500; font-size: 0.72em; color: var(--text-secondary); cursor: pointer; 
        }
        .product-name:hover { color: var(--primary); text-decoration: underline; }
        .hide-sku .product-sku { display: none; }
        
        .product-right { display: flex; align-items: center; gap: 10px; }
        .product-stock { text-align: center; min-width: 55px; }
        .stock-num { font-size: 1.3em; font-weight: 800; line-height: 1; }
        .stock-num.high { color: var(--success); }
        .stock-num.med { color: var(--warning); }
        .stock-num.low { color: var(--danger); }
        .stock-label { font-size: 0.65em; color: var(--text-secondary); text-transform: uppercase; }
        .stock-remaining { font-size: 0.65em; color: var(--text-secondary); }
        
        .qty-control { display: flex; align-items: center; background: var(--primary); border-radius: 8px; overflow: hidden; }
        .qty-btn {
            width: 32px; height: 32px; background: rgba(0,0,0,0.1); border: none;
            color: white; font-size: 1.1em; font-weight: 700; cursor: pointer;
        }
        .qty-btn:hover { background: rgba(0,0,0,0.2); }
        .qty-val { width: 28px; text-align: center; font-weight: 700; color: white; }
        
        .btn-add {
            width: 36px; height: 36px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-secondary); font-size: 1.2em; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-add:hover { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-add.no-stock { background: var(--danger); border-color: var(--danger); color: white; opacity: 0.7; }
        
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 10px; padding: 8px; }
        .page-btn {
            min-width: 34px; height: 34px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text-secondary); font-weight: 600; cursor: pointer; font-size: 0.85em;
        }
        .page-btn:hover { border-color: var(--primary); color: var(--primary); }
        .page-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .page-btn:disabled { opacity: 0.4; }
        
        /* IMAGE MODAL */
        .img-modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 400; align-items: center; justify-content: center; padding: 20px;
        }
        .img-modal-overlay.show { display: flex; }
        .img-modal-overlay img { max-width: 90vw; max-height: 80vh; border-radius: 12px; object-fit: contain; }
        .img-modal-close {
            position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2);
            border: none; color: white; font-size: 1.5em; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer;
        }
        
        /* ========= ARTICLE DETAIL VIEW ========= */
        .article-detail-view { display: none; list-style: none; }
        .article-detail-view.active { display: block; }
        .article-detail-view * { list-style: none; }
        
        .article-sticky-name {
            position: sticky; top: 0; z-index: 60;
            background: var(--primary); color: white;
            padding: 10px 16px; font-weight: 800; font-size: 1.05em;
            text-align: center; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .article-stats-row {
            display: flex; gap: 6px; padding: 6px 10px; justify-content: center; align-items: center;
            font-size: 0.75em; color: var(--text-secondary); margin-bottom: 2px;
        }
        .article-stats-row strong { color: var(--primary); }
        
        .article-color-section { margin-bottom: 2px; background: var(--bg-card); }
        .article-color-sticky {
            position: sticky; top: 42px; z-index: 55;
            background: var(--bg-card); border-bottom: 2px solid var(--primary);
            padding: 7px 50px 7px 14px; font-weight: 700; font-size: 0.9em;
            color: var(--primary); display: flex; align-items: center;
            justify-content: center; gap: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .article-color-sticky .color-stock-badge {
            font-size: 0.78em; color: var(--text-secondary); font-weight: 400;
            position: absolute; right: 14px;
        }
        .article-color-img {
            width: calc(100% - 16px); max-height: 220px; object-fit: contain;
            background: var(--bg-input); display: none; border-radius: 10px;
            margin: 6px auto; cursor: pointer;
        }
        .article-detail-view.show-photos .article-color-img { display: block; }
        
        .article-photo-toggle {
            padding: 4px 10px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 16px; font-size: 0.72em; color: var(--text-secondary); cursor: pointer;
            font-weight: 600; -webkit-tap-highlight-color: transparent;
        }
        .article-photo-toggle.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .article-color-strip {
            display: flex; gap: 6px; padding: 6px 8px; overflow-x: auto;
            -webkit-overflow-scrolling: touch; justify-content: center; flex-wrap: wrap;
        }
        .article-color-strip::-webkit-scrollbar { display: none; }
        .color-strip-item {
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            cursor: pointer; min-width: 56px; padding: 4px; border-radius: 8px;
            border: 2px solid transparent; transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        .color-strip-item.active { border-color: var(--primary); background: rgba(79,172,254,0.15); }
        .color-strip-item.zero-stock { opacity: 0.35; }
        .color-strip-item.zero-stock .color-strip-name { text-decoration: line-through; }
        .color-strip-img {
            width: 48px; height: 48px; border-radius: 6px; object-fit: cover;
            border: 1px solid var(--border); background: var(--bg-input);
        }
        .color-strip-placeholder {
            width: 48px; height: 48px; border-radius: 6px; background: var(--bg-input);
            display: flex; align-items: center; justify-content: center; font-size: 1.1em;
            border: 1px solid var(--border);
        }
        .color-strip-name {
            font-size: 0.6em; font-weight: 600; color: var(--text-secondary);
            max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            text-align: center;
        }
        .color-strip-badge {
            font-size: 0.55em; font-weight: 700; color: var(--success);
        }
        
        /* COLOR PHOTO OVERLAY */
        .color-photo-overlay {
            display: none; position: fixed; inset: 0; z-index: 350;
            background: rgba(0,0,0,0.92); overflow-y: auto;
            padding: 0; flex-direction: column;
        }
        .color-photo-overlay.show { display: flex; }
        .color-photo-header {
            position: sticky; top: 0; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border);
        }
        .color-photo-title { font-weight: 700; font-size: 1em; color: var(--primary); }
        .color-photo-close {
            background: none; border: none; color: var(--text); font-size: 1.5em;
            cursor: pointer; width: 36px; height: 36px; display: flex;
            align-items: center; justify-content: center;
        }
        .color-photo-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 4px; padding: 8px;
        }
        .color-photo-card {
            background: var(--bg-card); border-radius: 8px; overflow: hidden;
            cursor: pointer; border: 2px solid transparent; transition: all 0.15s;
            text-align: center;
        }
        .color-photo-card:hover { border-color: var(--primary); }
        .color-photo-card.active { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,172,254,0.4); }
        .color-photo-card.zero-stock { opacity: 0.35; }
        .color-photo-card .cp-img {
            width: 100%; aspect-ratio: 3/4; object-fit: cover; background: var(--bg-input);
            display: block;
        }
        .color-photo-card .cp-placeholder {
            width: 100%; aspect-ratio: 3/4; background: var(--bg-input);
            display: flex; align-items: center; justify-content: center; font-size: 2em;
            color: var(--text-secondary);
        }
        .color-photo-card .cp-name {
            padding: 6px 4px 2px; font-size: 0.72em; font-weight: 700; color: var(--text);
        }
        .color-photo-card.zero-stock .cp-name { text-decoration: line-through; }
        .color-photo-card .cp-stock {
            padding: 0 4px 6px; font-size: 0.62em; color: var(--text-secondary);
        }
        .color-photo-card.zero-stock .cp-stock { color: var(--danger); }
        
        /* STRIKETHROUGH ZERO-STOCK FILTER OPTS */
        .filter-opt.zero-stock { opacity: 0.4; text-decoration: line-through; }
        
        .article-sizes-grid {
            display: flex; flex-wrap: nowrap; gap: 3px; padding: 6px 4px;
            justify-content: center; overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .article-sizes-grid::-webkit-scrollbar { display: none; }
        
        .article-size-cell {
            min-width: 48px; flex: 1; max-width: 68px;
            text-align: center; padding: 8px 2px; border-radius: 10px;
            border: 2px solid var(--border); cursor: pointer; transition: all 0.15s;
            background: var(--bg-card); user-select: none; position: relative;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .article-size-cell:active { transform: scale(0.95); }
        .article-size-cell.in-cart {
            border-color: var(--success); background: rgba(74,222,128,0.12);
        }
        .article-size-cell.selected {
            border-color: var(--primary); background: rgba(79,172,254,0.18);
            box-shadow: 0 0 0 2px rgba(79,172,254,0.3);
        }
        .article-size-cell.zero { opacity: 0.5; }
        .article-size-cell.zero .asc-stock { text-decoration: line-through; color: var(--danger); }
        
        .asc-size { font-size: 0.72em; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; }
        .asc-stock { font-size: 1.3em; font-weight: 800; margin-top: 2px; line-height: 1; }
        .asc-stock.high { color: var(--success); }
        .asc-stock.med { color: var(--warning); }
        .asc-stock.low { color: var(--danger); }
        
        .asc-cart-badge {
            position: absolute; top: -6px; right: -6px; background: var(--primary);
            color: white; font-size: 0.6em; font-weight: 800; min-width: 18px; height: 18px;
            border-radius: 9px; display: flex; align-items: center; justify-content: center;
            padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        /* ARTICLE EDIT BAR (cart mode) */
        .article-edit-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); border-top: 2px solid var(--success);
            padding: 6px 10px 8px; z-index: 110;
            display: none; flex-direction: column; align-items: center; gap: 4px;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.5);
        }
        .article-edit-bar.show { display: flex; }
        .edit-bar-top {
            font-size: 0.82em; font-weight: 700; color: var(--success);
            text-align: center; width: 100%;
        }
        .edit-bar-controls {
            display: flex; align-items: center; gap: 8px; justify-content: center;
        }
        .edit-bar-controls .stock-btn {
            width: 52px; height: 52px; border-radius: 12px; font-size: 1.6em;
            border: none; font-weight: 700; cursor: pointer; color: white;
        }
        .edit-bar-controls .stock-btn.minus { background: var(--danger); }
        .edit-bar-controls .stock-btn.plus { background: var(--success); }
        .edit-bar-controls .edit-val {
            font-size: 1.8em; font-weight: 800; min-width: 40px; text-align: center;
            color: var(--primary);
        }
        .edit-bar-controls .stock-manual-input {
            width: 50px; padding: 10px 4px; font-size: 16px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg-input); color: var(--text);
            text-align: center; font-weight: 700;
        }
        .edit-bar-controls .stock-set-btn {
            padding: 12px 14px; border-radius: 10px; border: none;
            background: var(--primary); color: white; font-weight: 700; font-size: 1em; cursor: pointer;
            min-height: 52px;
        }
        
        /* PAGES */
        .page { display: none; }
        .page.active { display: block; }
        
        /* CART PAGE */
        .cart-header {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .cart-count { font-size: 1em; font-weight: 700; }
        .cart-count span { color: var(--primary); }
        
        .order-type-selector { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .order-type-btn {
            flex: 1; min-width: 90px; padding: 10px 6px; background: var(--bg-card);
            border: 2px solid var(--border); border-radius: 10px;
            color: var(--text-secondary); font-size: 0.78em; font-weight: 600;
            cursor: pointer; text-align: center;
        }
        .order-type-btn:hover { border-color: var(--primary); }
        .order-type-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .order-type-btn .icon { font-size: 1.4em; display: block; margin-bottom: 2px; }
        
        .order-form {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; margin-bottom: 10px;
        }
        .order-form-title { font-size: 0.85em; font-weight: 700; margin-bottom: 10px; color: var(--primary); }
        .form-group { margin-bottom: 10px; }
        .form-label { font-size: 0.72em; color: var(--text-secondary); margin-bottom: 4px; display: block; }
        .form-input {
            width: 100%; padding: 10px 12px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9em;
        }
        .form-input:focus { border-color: var(--primary); outline: none; }
        .form-input::placeholder { color: var(--text-secondary); }
        .form-input.error { border-color: var(--danger); animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .delivery-options { display: flex; flex-direction: column; gap: 6px; }
        .delivery-option {
            display: flex; align-items: center; gap: 10px; padding: 10px 12px;
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;
        }
        .delivery-option:hover { border-color: var(--primary); }
        .delivery-option.selected { border-color: var(--primary); background: rgba(79,172,254,0.15); }
        .delivery-option input[type="radio"] { display: none; }
        .delivery-radio {
            width: 18px; height: 18px; border: 2px solid var(--border);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .delivery-option.selected .delivery-radio { border-color: var(--primary); }
        .delivery-option.selected .delivery-radio::after {
            content: ''; width: 10px; height: 10px; background: var(--primary); border-radius: 50%;
        }
        .delivery-label { font-size: 0.82em; font-weight: 600; }
        .shipping-details, .payment-details { display: none; margin-top: 10px; }
        .shipping-details.show, .payment-details.show { display: block; }
        .form-textarea {
            width: 100%; padding: 10px 12px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 8px;
            color: var(--text); font-size: 0.85em; min-height: 70px; resize: vertical;
        }
        
        .budget-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; margin-bottom: 10px; display: none;
        }
        .budget-section.show { display: block; }
        .budget-title { font-size: 0.85em; font-weight: 700; margin-bottom: 10px; color: var(--warning); }
        .budget-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid var(--border);
        }
        .budget-item:last-child { border-bottom: none; }
        .budget-item-name { font-size: 0.8em; flex: 1; }
        .budget-item-qty { font-size: 0.75em; color: var(--text-secondary); margin: 0 8px; }
        .budget-item-price {
            width: 75px; padding: 6px 8px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); font-size: 0.82em; text-align: right;
        }
        .budget-item-subtotal { width: 75px; text-align: right; font-weight: 600; color: var(--success); font-size: 0.85em; }
        .budget-total {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0 0; margin-top: 8px; border-top: 2px solid var(--primary);
            font-size: 1.05em; font-weight: 700;
        }
        .budget-total-value { color: var(--success); }
        
        .export-btns { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .export-btn {
            flex: 1; min-width: 75px; padding: 12px 8px; border-radius: 10px; font-weight: 700;
            font-size: 0.82em; cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .export-btn.whatsapp { background: #25D366; color: white; }
        .export-btn.pdf { background: #dc2626; color: white; }
        .export-btn.ticket { background: #8b5cf6; color: white; }
        
        .cart-items { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .cart-item {
            padding: 10px 12px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 600; font-size: 0.85em; }
        .cart-item-meta { font-size: 0.72em; color: var(--text-secondary); }
        .cart-item-right { display: flex; align-items: center; gap: 8px; }
        .cart-qty { display: flex; align-items: center; gap: 4px; }
        .cart-qty-btn {
            width: 28px; height: 28px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); font-weight: 700; cursor: pointer;
        }
        .cart-qty-btn:hover { background: var(--primary); border-color: var(--primary); }
        .cart-qty-val { width: 28px; text-align: center; font-weight: 700; font-size: 0.9em; }
        .cart-remove { background: none; border: none; color: var(--danger); font-size: 1em; cursor: pointer; }
        
        /* FOOTER NAV */
        .footer-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); border-top: 1px solid var(--border); 
            padding: 6px 0 calc(4px + env(safe-area-inset-bottom, 0px)); z-index: 100;
        }
        .footer-inner { display: flex; justify-content: space-around; max-width: 400px; margin: 0 auto; }
        .nav-btn {
            background: none; border: none; color: var(--text-secondary);
            padding: 6px 28px; border-radius: 10px; cursor: pointer; position: relative;
        }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-icon { font-size: 1.1em; }
        .nav-label { font-size: 0.62em; display: block; margin-top: 1px; }
        .nav-badge {
            position: absolute; top: 0px; right: 16px; background: var(--danger);
            color: white; font-size: 0.58em; padding: 1px 5px; border-radius: 10px; font-weight: 700;
        }
        
        /* TOAST */
        .toast {
            position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); color: var(--text); padding: 8px 18px;
            border-radius: 20px; font-size: 0.82em; font-weight: 600;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; border: 1px solid var(--border);
            white-space: nowrap; max-width: 85vw; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .toast.show { opacity: 1; }
        .toast.warning { border-color: var(--warning); }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        
        /* MODALS */
        .clear-modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 500; align-items: center; justify-content: center;
        }
        .clear-modal-overlay.show { display: flex; }
        .clear-modal {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
            padding: 20px; width: 85%; max-width: 320px; text-align: center;
        }
        .clear-modal-title { font-size: 1em; font-weight: 700; margin-bottom: 6px; }
        .clear-modal-msg { font-size: 0.82em; color: var(--text-secondary); margin-bottom: 16px; }
        .clear-modal-btns { display: flex; gap: 10px; }
        .clear-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 10px;
            font-size: 0.9em; font-weight: 700; cursor: pointer;
        }
        .clear-modal-btn.no { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
        .clear-modal-btn.yes { background: var(--danger); color: white; }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; z-index: 300;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card); border-radius: 16px; padding: 20px;
            max-width: 340px; width: 90%; text-align: center;
        }
        .modal-icon { font-size: 2.5em; margin-bottom: 10px; }
        .modal-title { font-size: 1em; font-weight: 700; margin-bottom: 8px; }
        .modal-text { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 16px; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
        .modal-btn.cancel { background: var(--bg-input); color: var(--text-secondary); }
        .modal-btn.confirm { background: var(--primary); color: white; }
        
        /* SETTINGS MODAL */
        .settings-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            z-index: 300; align-items: flex-end; justify-content: center;
        }
        .settings-overlay.show { display: flex; }
        .settings-panel {
            background: var(--bg-card); border-radius: 16px 16px 0 0; width: 100%; max-width: 500px;
            padding: 20px; max-height: 70vh; overflow-y: auto;
        }
        .settings-title { font-size: 1em; font-weight: 700; margin-bottom: 16px; text-align: center; }
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .setting-label { font-size: 0.85em; }
        .setting-toggle {
            width: 44px; height: 24px; background: var(--bg-input); border-radius: 12px;
            position: relative; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s;
        }
        .setting-toggle.on { background: var(--primary); border-color: var(--primary); }
        .setting-toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 18px; height: 18px; background: white; border-radius: 50%; transition: all 0.2s;
        }
        .setting-toggle.on::after { left: 22px; }
        .settings-close {
            margin-top: 16px; width: 100%; padding: 12px; border: none; border-radius: 10px;
            background: var(--primary); color: white; font-weight: 700; font-size: 0.9em; cursor: pointer;
        }
        
        .empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 2.5em; margin-bottom: 8px; }
        
        .loading-screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .loading-screen.hidden { display: none; }
        .loading-spinner {
            width: 44px; height: 44px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 12px; color: var(--text-secondary); font-size: 0.9em; }
        .loading-error { margin-top: 16px; }
        .loading-error button {
            background: var(--primary); border: none; color: white;
            padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        
        @media (max-width: 640px) {
            body { padding-bottom: 65px; }
            .article-sticky-name { font-size: 0.95em; padding: 8px 12px; }
            .article-color-sticky { top: 38px; font-size: 0.85em; padding: 6px 12px; }
            .article-size-cell { min-width: 44px; padding: 7px 2px; }
            .asc-stock { font-size: 1.15em; }
            .asc-size { font-size: 0.68em; }
            .article-edit-bar { padding: 5px 6px calc(6px + env(safe-area-inset-bottom, 0px)); gap: 3px; }
            .edit-bar-controls .stock-btn { width: 50px; height: 50px; font-size: 1.5em; }
            .article-color-img { max-height: 180px; }
            .product-item { padding: 8px 10px; }
            .stock-num { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Cargando inventario...</div>
        <div class="loading-error" id="loadingError" style="display:none;">
            <button onclick="loadData(true)">üîÑ Reintentar</button>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modalTitle">Atenci√≥n</div>
            <div class="modal-text" id="modalText">Mensaje</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn confirm" id="modalConfirm" onclick="closeModal()">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
        <div class="settings-panel">
            <div class="settings-title">‚öôÔ∏è Ajustes</div>
            <div class="setting-row">
                <span class="setting-label">Mostrar SKU</span>
                <div class="setting-toggle on" id="toggleSku" onclick="toggleSetting('showSku')"></div>
            </div>
            <div class="setting-row">
                <span class="setting-label">Mostrar ubicaci√≥n</span>
                <div class="setting-toggle" id="toggleUbic" onclick="toggleSetting('showUbic')"></div>
            </div>
            <div class="setting-row" style="flex-direction:column;align-items:stretch;gap:8px;">
                <span class="setting-label">Cach√© de datos</span>
                <div id="cacheInfo" style="font-size:0.72em;color:var(--text-secondary);"></div>
                <button onclick="clearAllCache()" style="padding:10px;border:none;border-radius:8px;background:var(--danger);color:white;font-weight:700;font-size:0.82em;cursor:pointer;">üóëÔ∏è Borrar cach√© y recargar</button>
            </div>
            <button class="settings-close" onclick="closeSettings()">Cerrar</button>
        </div>
    </div>

    <!-- PRODUCTS PAGE -->
    <div class="page active" id="page-products">
        <div class="header">
            <div class="header-left">
                <span class="header-title">üõí Mikra Pedidos</span>
                <div class="sync-inline">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncStatus">Cargando...</span>
                    <span id="syncTime"></span>
                </div>
            </div>
            <div class="header-right">
                <button class="icon-btn" onclick="loadData(true)" title="Sync">üîÑ</button>
                <button class="icon-btn" onclick="openSettings()" title="Ajustes">‚öôÔ∏è</button>
            </div>
        </div>
        
        <div class="container">
            <div class="search-container">
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" id="searchInput" placeholder="Buscar art√≠culo, SKU, color..." autocomplete="off">
                    <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
                </div>
                <div class="autocomplete" id="autocomplete"></div>
            </div>
            
            <div class="filter-row" id="stockFilters">
                <div class="filter-chip active" data-stock="all">üì¶ Todos</div>
                <div class="filter-chip stock" data-stock="yes">‚úÖ Stock</div>
                <div class="filter-chip low" data-stock="low">‚ö†Ô∏è Bajo</div>
                <div class="filter-chip out" data-stock="no">‚ùå Sin</div>
                <div class="filter-chip" id="locationBtn" onclick="toggleLocationSearch()">üìç</div>
            </div>

            <div class="location-search" id="locationSearch">
                <div class="search-box" style="margin-bottom:0;">
                    <span>üìç</span>
                    <input type="text" id="locationInput" placeholder="Ej: 1000, 3000..." onkeyup="filterByLocation()">
                    <button class="search-clear show" onclick="clearLocationSearch()">‚úï</button>
                </div>
            </div>
            
            <div class="filters-collapse" id="filtersCollapse">
                <div class="filters-header">
                    <span onclick="toggleFilters()" style="flex:1;cursor:pointer;">üé® Color / üìè Talle</span>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <div class="active-filters" id="activeFilters"></div>
                        <button class="article-photo-toggle" id="colorXFotoBtn" onclick="openColorPhotoOverlay()" style="font-size:0.7em;">üì∑ Color x Foto</button>
                        <span class="filters-arrow" onclick="toggleFilters()" style="cursor:pointer;">‚ñº</span>
                    </div>
                </div>
                <div class="filters-body">
                    <div class="filter-section-title">üé® Colores</div>
                    <div class="filter-options" id="colorOptions"></div>
                    <div class="filter-section-title">üìè Talles</div>
                    <div class="filter-options" id="sizeOptions"></div>
                </div>
            </div>
            
            <div class="results-info">
                Mostrando <strong id="showingCount">0</strong> de <strong id="totalCount">0</strong>
            </div>
            
            <div class="product-list" id="productList"></div>
            <div class="pagination" id="pagination"></div>
            
            <div class="article-detail-view" id="articleDetailView">
                <div class="article-sticky-name" id="articleStickyName"></div>
                <div id="articleDetailContent"></div>
            </div>
        </div>
    </div>
    
    <!-- ARTICLE EDIT BAR (cart controls) -->
    <div class="article-edit-bar" id="articleEditBar">
        <button onclick="closeEditBar()" style="position:absolute;top:4px;right:10px;background:none;border:none;color:var(--text-secondary);font-size:1.2em;cursor:pointer;padding:4px 8px;">‚úï</button>
        <div class="edit-bar-top" id="articleEditLabel">‚Äî</div>
        <div class="edit-bar-controls">
            <button class="stock-btn minus" onclick="articleChangeQty(-1)">‚àí</button>
            <div class="edit-val" id="articleEditVal">0</div>
            <button class="stock-btn plus" onclick="articleChangeQty(1)">+</button>
            <input type="number" class="stock-manual-input" id="articleManualInput" placeholder="#" min="0">
            <button class="stock-set-btn" onclick="articleSetManual()">‚úì</button>
        </div>
    </div>

    <!-- CART PAGE -->
    <div class="page" id="page-cart">
        <div class="header">
            <div class="header-left"><span class="header-title">üõí Mi Pedido</span></div>
        </div>
        <div class="container">
            <div class="cart-header">
                <div class="cart-count"><span id="cartItemCount">0</span> prod. (<span id="cartUnitCount">0</span> uds)</div>
                <button class="cart-remove" onclick="clearCart()" style="font-size:0.82em;">üóëÔ∏è Vaciar</button>
            </div>
            
            <div class="order-type-selector">
                <div class="order-type-btn active" data-type="pedido" onclick="setOrderType('pedido')">
                    <span class="icon">üìã</span>Pedido
                </div>
                <div class="order-type-btn" data-type="reposicion" onclick="setOrderType('reposicion')">
                    <span class="icon">üîÑ</span>Reposici√≥n
                </div>
                <div class="order-type-btn" data-type="presupuesto" onclick="setOrderType('presupuesto')">
                    <span class="icon">üí∞</span>Presupuesto
                </div>
            </div>
            
            <div class="order-form" id="pedidoForm">
                <div class="order-form-title">üìã Datos del Pedido</div>
                <div class="form-group">
                    <label class="form-label">Nombre del cliente *</label>
                    <input type="text" class="form-input" id="clientName" placeholder="Nombre...">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de entrega</label>
                    <div class="delivery-options">
                        <label class="delivery-option selected" data-delivery="local">
                            <input type="radio" name="delivery" value="local" checked>
                            <span class="delivery-radio"></span>
                            <span class="delivery-label">üè™ Retira por Local</span>
                        </label>
                        <label class="delivery-option" data-delivery="deposito">
                            <input type="radio" name="delivery" value="deposito">
                            <span class="delivery-radio"></span>
                            <span class="delivery-label">üì¶ Retira por Dep√≥sito</span>
                        </label>
                        <label class="delivery-option" data-delivery="envio">
                            <input type="radio" name="delivery" value="envio">
                            <span class="delivery-radio"></span>
                            <span class="delivery-label">üöö Env√≠o</span>
                        </label>
                    </div>
                </div>
                <div class="shipping-details" id="shippingDetails">
                    <div class="form-group">
                        <label class="form-label">Datos del env√≠o</label>
                        <textarea class="form-textarea" id="shippingAddress" placeholder="Direcci√≥n, tel√©fono..."></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Estado del pago</label>
                    <div class="delivery-options">
                        <label class="delivery-option selected" data-payment="abonado">
                            <input type="radio" name="payment" value="abonado" checked>
                            <span class="delivery-radio"></span>
                            <span class="delivery-label">‚úÖ Ya abon√≥</span>
                        </label>
                        <label class="delivery-option" data-payment="pendiente">
                            <input type="radio" name="payment" value="pendiente">
                            <span class="delivery-radio"></span>
                            <span class="delivery-label">‚è≥ Falta abonar</span>
                        </label>
                    </div>
                </div>
                <div class="payment-details" id="paymentDetails">
                    <div class="form-group">
                        <label class="form-label">Monto a abonar *</label>
                        <input type="text" class="form-input" id="paymentAmount" placeholder="$0">
                    </div>
                </div>
            </div>
            
            <div class="order-form" id="reposicionForm" style="display:none;">
                <div class="order-form-title">üîÑ Reposici√≥n Galer√≠a</div>
                <p style="font-size:0.82em;color:var(--text-secondary);">Sin datos adicionales requeridos</p>
            </div>
            
            <div class="budget-section" id="budgetSection">
                <div class="budget-title">üí∞ Presupuesto</div>
                <div id="budgetItems"></div>
                <div class="budget-total">
                    <span>TOTAL:</span>
                    <span class="budget-total-value" id="budgetTotal">$0</span>
                </div>
            </div>
            
            <div class="export-btns">
                <button class="export-btn whatsapp" onclick="shareWhatsApp()">üì± WhatsApp</button>
                <button class="export-btn pdf" onclick="downloadPDF()">üìÑ PDF</button>
                <button class="export-btn ticket" onclick="downloadTicket()">üé´ Ticket</button>
                <button class="export-btn" style="background:var(--primary);color:white;" onclick="downloadPreparacion()">üì¶ Preparar</button>
            </div>
            
            <div class="cart-items" id="cartItems"></div>
        </div>
    </div>
    
    <nav class="footer-nav" id="footerNav">
        <div class="footer-inner">
            <button class="nav-btn active" data-page="products">
                <span class="nav-icon">üì¶</span>
                <span class="nav-label">Stock</span>
            </button>
            <button class="nav-btn" data-page="cart">
                <span class="nav-icon">üõí</span>
                <span class="nav-badge" id="cartBadge" style="display:none">0</span>
                <span class="nav-label">Pedido</span>
            </button>
        </div>
    </nav>
    
    <div class="toast" id="toast"></div>
    
    <!-- COLOR PHOTO OVERLAY -->
    <div class="color-photo-overlay" id="colorPhotoOverlay">
        <div class="color-photo-header">
            <span class="color-photo-title" id="colorPhotoTitle">Colores</span>
            <button class="color-photo-close" onclick="closeColorPhotoOverlay()">‚úï</button>
        </div>
        <div class="color-photo-grid" id="colorPhotoGrid"></div>
    </div>
    
    <div class="img-modal-overlay" id="imgModal" onclick="closeImgModal()">
        <button class="img-modal-close" onclick="closeImgModal()">‚úï</button>
        <img id="imgModalSrc" src="" alt="Producto">
    </div>
    
    <div class="clear-modal-overlay" id="clearModal">
        <div class="clear-modal">
            <div class="clear-modal-title">Pedido compartido</div>
            <div class="clear-modal-msg">¬øQu√© quer√©s hacer?</div>
            <div class="clear-modal-btns" style="flex-direction:column;gap:8px;">
                <button class="clear-modal-btn" style="background:var(--primary);color:white;" onclick="closeClearModal();downloadPreparacion()">üì¶ Ver hoja de preparaci√≥n</button>
                <button class="clear-modal-btn yes" onclick="confirmClearCart()">üóëÔ∏è Vaciar carrito</button>
                <button class="clear-modal-btn no" onclick="closeClearModal()">Seguir editando</button>
            </div>
        </div>
    </div>
    <div class="clear-modal-overlay" id="ticketTypeModal">
        <div class="clear-modal">
            <div class="clear-modal-title">üé´ Tipo de Ticket</div>
            <div class="clear-modal-msg">¬øQu√© formato quer√©s imprimir?</div>
            <div class="clear-modal-btns" style="flex-direction:column;gap:8px;">
                <button class="clear-modal-btn" style="background:#8b5cf6;color:white;font-size:0.95em;" onclick="closeTicketTypeModal();downloadTicketDetalle()">üìã Detalle (precios y SKU)</button>
                <button class="clear-modal-btn" style="background:var(--success);color:#1a2744;font-size:0.95em;font-weight:800;" onclick="closeTicketTypeModal();showPreparadosOptions()">üì¶ Preparados (para armar)</button>
                <button class="clear-modal-btn no" onclick="closeTicketTypeModal()">Cancelar</button>
            </div>
        </div>
    </div>
    <div class="clear-modal-overlay" id="preparadosOptModal">
        <div class="clear-modal">
            <div class="clear-modal-title">üì¶ Preparados</div>
            <div class="clear-modal-msg">¬øC√≥mo lo quer√©s?</div>
            <div class="clear-modal-btns" style="flex-direction:column;gap:8px;">
                <button class="clear-modal-btn" style="background:var(--success);color:#1a2744;font-size:0.95em;font-weight:800;" onclick="closePreparadosOpt();downloadTicketPreparados('print')">üñ®Ô∏è Imprimir</button>
                <button class="clear-modal-btn" style="background:var(--primary);color:white;font-size:0.95em;font-weight:800;" onclick="closePreparadosOpt();downloadTicketPreparados('pdf')">üì§ Compartir / PDF</button>
                <button class="clear-modal-btn no" onclick="closePreparadosOpt()">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbycz2hrgjQxRCvVKtW0o-HAuMQYTfmiBHSgJPFZTX34PwBpAladxb8ZPpt-Vg09zplx/exec';
        const SIZE_ORDER = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
        
        let PRODUCTS = [];
        let UNIQUE_ARTICLES = [];
        let IMAGES_MAP = {};
        let articlePrices = {};
        let modalCallback = null;
        let articleSelectedId = null;
        let forceListView = false;
        let articleColorFilter = ''; // '' = all colors
        let showColorStrip = false;
        
        const settings = {
            showSku: JSON.parse(localStorage.getItem('mikra_ord_showSku') ?? 'true'),
            showUbic: JSON.parse(localStorage.getItem('mikra_ord_showUbic') ?? 'false'),
        };
        
        const state = {
            filtered: [], search: '', searchExact: false, stock: 'all',
            color: '', size: '', location: '', page: 1, pageSize: 50,
            cart: JSON.parse(localStorage.getItem('mikra_cart') || '[]'),
            orderType: 'pedido', showImages: false
        };
        
        const $ = id => document.getElementById(id);
        
        // ===== SETTINGS =====
        function openSettings() { 
            $('settingsOverlay').classList.add('show'); 
            updateSettingsUI();
            // Show cache info
            const imgCount = Object.keys(IMAGES_MAP).length;
            const prodCount = PRODUCTS.length;
            const lastSync = localStorage.getItem('mikra_lastSync');
            const lastDate = lastSync ? new Date(lastSync).toLocaleString() : 'Nunca';
            const cacheSize = ((localStorage.getItem('mikra_products') || '').length + (localStorage.getItem('mikra_images') || '').length) / 1024;
            $('cacheInfo').innerHTML = 
                'üì¶ Productos: <strong>' + prodCount + '</strong> ¬∑ ' +
                'üì∑ Im√°genes: <strong>' + imgCount + '</strong><br>' +
                'üïê √öltima sync: ' + lastDate + '<br>' +
                'üíæ Tama√±o cach√©: ' + cacheSize.toFixed(0) + ' KB';
        }
        function closeSettings() { $('settingsOverlay').classList.remove('show'); }
        
        function clearAllCache() {
            if (!confirm('¬øBorrar todo el cach√© y recargar?\nSe perder√°n los datos offline.')) return;
            localStorage.removeItem('mikra_products');
            localStorage.removeItem('mikra_images');
            localStorage.removeItem('mikra_lastSync');
            PRODUCTS = [];
            IMAGES_MAP = {};
            SEARCH_INDEX = [];
            toast('üóëÔ∏è Cach√© borrado. Recargando...');
            closeSettings();
            setTimeout(() => location.reload(), 500);
        }
        function updateSettingsUI() {
            $('toggleSku').classList.toggle('on', settings.showSku);
            $('toggleUbic').classList.toggle('on', settings.showUbic);
        }
        function toggleSetting(key) {
            settings[key] = !settings[key];
            localStorage.setItem('mikra_ord_' + key, JSON.stringify(settings[key]));
            updateSettingsUI();
            applySettingsToUI();
        }
        function applySettingsToUI() {
            document.body.classList.toggle('hide-sku', !settings.showSku);
        }
        
        // ===== MODAL =====
        function showModal(icon, title, text, confirmText, callback) {
            $('modalIcon').textContent = icon;
            $('modalTitle').textContent = title;
            $('modalText').textContent = text;
            $('modalConfirm').textContent = confirmText || 'Aceptar';
            modalCallback = callback;
            $('modal').classList.add('show');
        }
        function closeModal() {
            $('modal').classList.remove('show');
            if (modalCallback) modalCallback();
            modalCallback = null;
        }
        
        // ===== CART =====
        function getCartQty(productId) {
            const item = state.cart.find(c => c.id === productId);
            return item ? item.qty : 0;
        }
        function addToCart(id, noStock) {
            if (noStock && !confirm('‚ö†Ô∏è Sin stock. ¬øAgregar igual?')) return;
            const p = PRODUCTS.find(x => x.id === id);
            if (!p) return;
            const existing = state.cart.find(c => c.id === id);
            if (existing) { existing.qty += 1; }
            else { state.cart.push({ ...p, qty: 1 }); }
            saveCart(); updateBadge();
            return p;
        }
        function changeQty(id, delta, e) {
            if (e) e.stopPropagation();
            const idx = state.cart.findIndex(c => c.id === id);
            if (idx >= 0) {
                state.cart[idx].qty += delta;
                if (state.cart[idx].qty <= 0) { state.cart.splice(idx, 1); }
                saveCart(); updateBadge(); render();
            }
        }
        function saveCart() { localStorage.setItem('mikra_cart', JSON.stringify(state.cart)); }
        function updateBadge() {
            const units = state.cart.reduce((a, p) => a + p.qty, 0);
            $('cartBadge').textContent = units;
            $('cartBadge').style.display = units > 0 ? 'block' : 'none';
            $('cartItemCount').textContent = state.cart.length;
            $('cartUnitCount').textContent = units;
        }
        
        function setOrderType(type) {
            state.orderType = type;
            document.querySelectorAll('.order-type-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-type="' + type + '"]').classList.add('active');
            $('pedidoForm').style.display = type === 'pedido' ? 'block' : 'none';
            $('reposicionForm').style.display = type === 'reposicion' ? 'block' : 'none';
            $('budgetSection').classList.toggle('show', type === 'presupuesto');
            if (type === 'presupuesto') renderBudget();
        }
        
        function renderBudget() {
            const grouped = {};
            state.cart.forEach(p => {
                const name = p.titulo || p.articulo;
                if (!grouped[name]) grouped[name] = { name, qty: 0, price: articlePrices[name] || 0 };
                grouped[name].qty += p.qty;
            });
            const items = Object.values(grouped);
            $('budgetItems').innerHTML = items.map(item =>
                '<div class="budget-item"><span class="budget-item-name">' + item.name + '</span>' +
                '<span class="budget-item-qty">x' + item.qty + '</span>' +
                '<input type="number" class="budget-item-price" value="' + item.price + '" ' +
                'onchange="updatePrice(\'' + item.name.replace(/'/g, "\\'") + '\', this.value)" placeholder="$">' +
                '<span class="budget-item-subtotal">$' + (item.qty * item.price).toLocaleString() + '</span></div>'
            ).join('');
            updateBudgetTotal();
        }
        function updatePrice(name, price) { articlePrices[name] = parseFloat(price) || 0; renderBudget(); }
        function updateBudgetTotal() {
            let total = 0;
            state.cart.forEach(p => { total += p.qty * (articlePrices[p.titulo || p.articulo] || 0); });
            $('budgetTotal').textContent = '$' + total.toLocaleString();
        }
        
        function renderCart() {
            if (!state.cart.length) {
                $('cartItems').innerHTML = '<div class="empty"><div class="empty-icon">üõí</div><div>Carrito vac√≠o</div></div>';
                return;
            }
            const showSku = settings.showSku;
            $('cartItems').innerHTML = state.cart.map((p, i) =>
                '<div class="cart-item"><div class="cart-item-info">' +
                '<div class="cart-item-name">' + (p.titulo || p.articulo) + '</div>' +
                '<div class="cart-item-meta">' + (showSku ? p.codigo + ' ‚Ä¢ ' : '') + (p.color || '-') + ' ‚Ä¢ T:' + (p.talle || '-') + '</div></div>' +
                '<div class="cart-item-right"><div class="cart-qty">' +
                '<button class="cart-qty-btn" onclick="cartQty(' + i + ',-1)">‚àí</button>' +
                '<span class="cart-qty-val">' + p.qty + '</span>' +
                '<button class="cart-qty-btn" onclick="cartQty(' + i + ',1)">+</button></div>' +
                '<button class="cart-remove" onclick="removeCart(' + i + ')">üóë</button></div></div>'
            ).join('');
            if (state.orderType === 'presupuesto') renderBudget();
        }
        function cartQty(i, d) {
            state.cart[i].qty += d;
            if (state.cart[i].qty <= 0) state.cart.splice(i, 1);
            saveCart(); renderCart(); updateBadge(); render();
        }
        function removeCart(i) { state.cart.splice(i, 1); saveCart(); renderCart(); updateBadge(); render(); }
        function clearCart() {
            if (!confirm('¬øVaciar todo?')) return;
            state.cart = []; articlePrices = {}; saveCart(); renderCart(); updateBadge(); render();
        }
        
        // ===== DEBOUNCE UTILITY =====
        function debounce(fn, ms) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), ms);
            };
        }
        
        // ===== SEARCH INDEX =====
        let SEARCH_INDEX = [];
        
        function buildSearchIndex() {
            SEARCH_INDEX = PRODUCTS.map(p => ({
                ...p,
                _search: [p.codigo, p.titulo, p.articulo, p.color, p.ubicacion]
                    .filter(Boolean).join(' ').toLowerCase(),
                _titulo: (p.titulo || '').toLowerCase(),
                _articulo: (p.articulo || '').toLowerCase(),
                _color: (p.color || '').toLowerCase(),
                _ubicacion: (p.ubicacion || '').toLowerCase()
            }));
        }
        
        // ===== DATA ‚Äî CACHE-FIRST LOADING =====
        const CACHE_MAX_AGE_MS = 5 * 60 * 1000; // 5 min
        
        function loadFromCache() {
            try {
                const cached = localStorage.getItem('mikra_products');
                if (!cached) return false;
                PRODUCTS = JSON.parse(cached);
                try { IMAGES_MAP = JSON.parse(localStorage.getItem('mikra_images') || '{}'); } catch(e) {}
                buildSearchIndex();
                updateUniqueArticles();
                applyFilters();
                const lastSync = localStorage.getItem('mikra_lastSync');
                if (lastSync) {
                    const ago = Date.now() - new Date(lastSync).getTime();
                    const mins = Math.floor(ago / 60000);
                    $('syncTime').textContent = mins < 1 ? '‚Ä¢ Reciente' : '‚Ä¢ Hace ' + mins + ' min';
                } else {
                    $('syncTime').textContent = '‚Ä¢ Cach√©';
                }
                return true;
            } catch(e) { return false; }
        }
        
        function isCacheFresh() {
            try {
                const lastSync = localStorage.getItem('mikra_lastSync');
                if (!lastSync) return false;
                return (Date.now() - new Date(lastSync).getTime()) < CACHE_MAX_AGE_MS;
            } catch(e) { return false; }
        }
        
        async function syncFromAPI(isBackground) {
            $('syncDot').classList.add('loading');
            $('syncDot').classList.remove('error');
            $('syncStatus').textContent = 'Sincronizando...';
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);
            try {
                const response = await fetch(API_URL, { signal: controller.signal });
                clearTimeout(timeout);
                const data = await response.json();
                if (data.success && data.products && data.products.length > 0) {
                    PRODUCTS = data.products;
                    
                    // Images handling
                    if (data.images && typeof data.images === 'object') {
                        IMAGES_MAP = data.images;
                        localStorage.setItem('mikra_images', JSON.stringify(IMAGES_MAP));
                    } else {
                        try { 
                            const cached = JSON.parse(localStorage.getItem('mikra_images') || '{}');
                            if (Object.keys(cached).length > 0) IMAGES_MAP = cached;
                        } catch(e) {}
                    }
                    
                    // Also check if products have image URLs embedded
                    if (Object.keys(IMAGES_MAP).length === 0) {
                        PRODUCTS.forEach(p => {
                            if (p.imagen && p.codigo) IMAGES_MAP[p.codigo] = p.imagen;
                            if (p.image && p.codigo) IMAGES_MAP[p.codigo] = p.image;
                            if (p.img && p.codigo) IMAGES_MAP[p.codigo] = p.img;
                            if (p.thumbnail && p.codigo) IMAGES_MAP[p.codigo] = p.thumbnail;
                        });
                        if (Object.keys(IMAGES_MAP).length > 0) {
                            localStorage.setItem('mikra_images', JSON.stringify(IMAGES_MAP));
                        }
                    }
                    
                    localStorage.setItem('mikra_products', JSON.stringify(PRODUCTS));
                    localStorage.setItem('mikra_lastSync', new Date().toISOString());
                    buildSearchIndex();
                    updateUniqueArticles();
                    applyFilters();
                    $('syncDot').classList.remove('loading', 'error');
                    $('syncStatus').textContent = 'Sincronizado';
                    $('syncTime').textContent = '‚Ä¢ ' + new Date().toLocaleTimeString();
                    $('loadingScreen').classList.add('hidden');
                    const imgCount = Object.keys(IMAGES_MAP).length;
                    if (isBackground) toast('‚úì Actualizado', 'success');
                    else toast('‚úì ' + data.count + ' prod. ¬∑ ' + imgCount + ' img', 'success');
                } else throw new Error('No products');
            } catch (error) {
                clearTimeout(timeout);
                $('syncDot').classList.remove('loading');
                $('syncDot').classList.add('error');
                $('syncStatus').textContent = 'Error';
                if (!PRODUCTS.length) {
                    const cached = localStorage.getItem('mikra_products');
                    if (cached) {
                        PRODUCTS = JSON.parse(cached);
                        try { IMAGES_MAP = JSON.parse(localStorage.getItem('mikra_images') || '{}'); } catch(e) {}
                        buildSearchIndex();
                        updateUniqueArticles();
                        applyFilters();
                        $('loadingScreen').classList.add('hidden');
                        $('syncTime').textContent = '‚Ä¢ Cach√©';
                        toast('‚ö†Ô∏è Usando cach√©', 'warning');
                    } else {
                        $('loadingText').textContent = '‚ùå Error de conexi√≥n';
                        $('loadingError').style.display = 'block';
                    }
                } else {
                    if (isBackground) toast('‚ö†Ô∏è No se pudo sincronizar', 'warning');
                }
            }
        }
        
        async function loadData(forceSync) {
            const hasCache = loadFromCache();
            if (hasCache) {
                $('loadingScreen').classList.add('hidden');
                $('syncDot').classList.remove('loading', 'error');
                $('syncStatus').textContent = 'Cach√©';
                if (!forceSync && isCacheFresh()) {
                    $('syncStatus').textContent = 'Listo';
                    return;
                }
                syncFromAPI(true);
            } else {
                $('loadingText').textContent = 'Cargando inventario...';
                $('loadingError').style.display = 'none';
                syncFromAPI(false);
            }
        }
        
        function updateUniqueArticles() {
            const articles = {};
            PRODUCTS.forEach(p => {
                const name = p.titulo || p.articulo || '';
                if (name) {
                    if (!articles[name]) articles[name] = { name, totalStock: 0 };
                    articles[name].totalStock += p.stock || 0;
                }
            });
            UNIQUE_ARTICLES = Object.values(articles).sort((a, b) => b.totalStock - a.totalStock);
        }
        
        function sortProducts(products) {
            return products.sort((a, b) => {
                const ca = a._color || (a.color || '').toLowerCase(), cb = b._color || (b.color || '').toLowerCase();
                if (ca !== cb) return ca.localeCompare(cb);
                const sa = a.talle || '', sb = b.talle || '';
                const na = parseInt(sa), nb = parseInt(sb);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                const ia = SIZE_ORDER.indexOf(sa.toUpperCase()), ib = SIZE_ORDER.indexOf(sb.toUpperCase());
                if (ia !== -1 && ib !== -1) return ia - ib;
                if (ia !== -1) return -1; if (ib !== -1) return 1;
                return sa.localeCompare(sb);
            });
        }
        
        // ===== SEARCH & FILTERS =====
        function showAutocomplete(query) {
            if (!query || query.length < 2) { $('autocomplete').classList.remove('show'); return; }
            const q = query.toLowerCase();
            const matches = UNIQUE_ARTICLES.filter(a => a.name.toLowerCase().includes(q)).slice(0, 10);
            if (!matches.length) { $('autocomplete').classList.remove('show'); return; }
            $('autocomplete').innerHTML = matches.map(a => 
                '<div class="autocomplete-item" data-name="' + a.name.replace(/"/g, '&quot;') + '">' +
                '<span class="autocomplete-name">' + a.name + '</span>' +
                '<span class="autocomplete-stock">' + a.totalStock + ' uds</span></div>'
            ).join('');
            $('autocomplete').classList.add('show');
        }
        
        function clearSearch() {
            $('searchInput').value = '';
            state.search = ''; state.searchExact = false; state.color = ''; state.size = '';
            $('searchClear').classList.remove('show'); $('autocomplete').classList.remove('show');
            forceListView = false; articleColorFilter = ''; showColorStrip = false;
            applyFilters();
        }
        
        function searchArticle(name) {
            if (!name) return;
            $('searchInput').value = name; state.search = name; state.searchExact = true;
            forceListView = false; articleColorFilter = ''; showColorStrip = false;
            $('searchClear').classList.add('show'); $('autocomplete').classList.remove('show');
            applyFilters();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function toggleFilters() { $('filtersCollapse').classList.toggle('open'); }
        function toggleLocationSearch() {
            const vis = $('locationSearch').style.display !== 'block';
            $('locationSearch').style.display = vis ? 'block' : 'none';
            $('locationBtn').classList.toggle('active', vis);
            if (vis) $('locationInput').focus(); else clearLocationSearch();
        }
        function filterByLocation() { state.location = $('locationInput').value.trim(); applyFilters(); }
        function clearLocationSearch() {
            $('locationInput').value = ''; state.location = '';
            $('locationSearch').style.display = 'none'; $('locationBtn').classList.remove('active');
            applyFilters();
        }
        
        function applyFilters() {
            let r = SEARCH_INDEX.length ? [...SEARCH_INDEX] : [...PRODUCTS];
            if (state.stock === 'yes') r = r.filter(p => p.stock > 0);
            else if (state.stock === 'low') r = r.filter(p => p.stock > 0 && p.stock <= 5);
            else if (state.stock === 'no') r = r.filter(p => p.stock === 0);
            if (state.search) {
                const q = state.search.toLowerCase();
                if (state.searchExact) {
                    r = r.filter(p => (p._titulo || (p.titulo||'').toLowerCase()) === q || (p._articulo || (p.articulo||'').toLowerCase()) === q);
                } else {
                    r = r.filter(p => (p._search || '').includes(q));
                }
            }
            if (state.location) { const loc = state.location.toLowerCase(); r = r.filter(p => (p._ubicacion || (p.ubicacion||'').toLowerCase()).includes(loc)); }
            updateDynamicFilters(r);
            if (state.color) r = r.filter(p => p.color === state.color);
            if (state.size) r = r.filter(p => p.talle === state.size);
            r = sortProducts(r);
            state.filtered = r; state.page = 1;
            render(); updateActiveFilterTags();
        }
        
        function updateActiveFilterTags() {
            let tags = '';
            if (state.color) tags += '<span class="active-filter-tag" onclick="clearColorFilter(event)">' + state.color + ' <span class="tag-x">‚úï</span></span>';
            if (state.size) tags += '<span class="active-filter-tag" onclick="clearSizeFilter(event)">T:' + state.size + ' <span class="tag-x">‚úï</span></span>';
            if (state.color || state.size) tags += '<span class="clear-all-filters-btn" onclick="clearAllQuickFilters(event)">Limpiar</span>';
            $('activeFilters').innerHTML = tags;
        }
        
        function clearColorFilter(e) { if(e) e.stopPropagation(); state.color = ''; articleColorFilter = ''; applyFilters(); }
        function clearSizeFilter(e) { if(e) e.stopPropagation(); state.size = ''; applyFilters(); }
        function clearAllQuickFilters(e) { if(e) e.stopPropagation(); state.color = ''; state.size = ''; articleColorFilter = ''; applyFilters(); }
        let colorStockMap = {}; // { colorName: { stock, avail, imgUrl } }
        
        function updateDynamicFilters(results) {
            const colors = [...new Set(results.map(p => p.color).filter(Boolean))].sort();
            const sizes = [...new Set(results.map(p => p.talle).filter(Boolean))];
            sizes.sort((a, b) => {
                const na = parseInt(a), nb = parseInt(b);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                const ia = SIZE_ORDER.indexOf(a.toUpperCase()), ib = SIZE_ORDER.indexOf(b.toUpperCase());
                if (ia !== -1 && ib !== -1) return ia - ib;
                return a.localeCompare(b);
            });
            
            // Calculate stock per color (available = stock - cart), considering selected size
            colorStockMap = {};
            colors.forEach(c => {
                let prods = results.filter(p => p.color === c);
                if (state.size) prods = prods.filter(p => p.talle === state.size);
                let stock = 0, cart = 0, imgUrl = '';
                prods.forEach(p => { stock += p.stock || 0; cart += getCartQty(p.id); });
                // Image: always from all prods of this color (not filtered by size)
                const allColorProds = results.filter(p => p.color === c);
                for (const p of allColorProds) { imgUrl = getProductImageFull(p.codigo, p); if (imgUrl) break; }
                colorStockMap[c] = { stock, avail: stock - cart, cart, imgUrl };
            });
            
            $('colorOptions').innerHTML = '<div class="filter-opt' + (!state.color ? ' active' : '') + '" data-color="">Todos</div>' +
                colors.map(c => {
                    const zs = colorStockMap[c] && colorStockMap[c].avail <= 0 ? ' zero-stock' : '';
                    return '<div class="filter-opt' + (state.color === c ? ' active' : '') + zs + '" data-color="' + c + '">' + c + '</div>';
                }).join('');
            
            // Calculate stock per size (considering selected color)
            const sizeStockMap = {};
            sizes.forEach(s => {
                let prods = results.filter(p => p.talle === s);
                if (state.color) prods = prods.filter(p => p.color === state.color);
                let stock = 0;
                prods.forEach(p => { stock += (p.stock || 0) - getCartQty(p.id); });
                sizeStockMap[s] = stock;
            });
            
            $('sizeOptions').innerHTML = '<div class="filter-opt' + (!state.size ? ' active' : '') + '" data-size="">Todos</div>' +
                sizes.map(s => {
                    const zs = sizeStockMap[s] <= 0 ? ' zero-stock' : '';
                    return '<div class="filter-opt' + (state.size === s ? ' active' : '') + zs + '" data-size="' + s + '">' + s + '</div>';
                }).join('');
        }
        
        // ===== COLOR PHOTO OVERLAY =====
        function openColorPhotoOverlay() {
            const colors = Object.keys(colorStockMap).sort();
            if (!colors.length) { toast('No hay colores disponibles', 'warning'); return; }
            
            const articleName = state.searchExact ? state.search : '';
            $('colorPhotoTitle').textContent = articleName ? articleName : 'Colores';
            
            let html = '';
            colors.forEach(c => {
                const cm = colorStockMap[c];
                const isZero = cm.avail <= 0;
                const isActive = state.color === c;
                const imgUrl = cm.imgUrl;
                const thumbUrl = imgUrl || '';
                
                html += '<div class="color-photo-card' + (isZero ? ' zero-stock' : '') + (isActive ? ' active' : '') + '" onclick="selectColorFromOverlay(\'' + c.replace(/'/g, "\\'") + '\')">';
                if (thumbUrl) {
                    html += '<img class="cp-img" src="' + thumbUrl + '" loading="lazy" onerror="this.outerHTML=\'<div class=cp-placeholder>üì¶</div>\'">';
                } else {
                    html += '<div class="cp-placeholder">üì¶</div>';
                }
                html += '<div class="cp-name">' + c + '</div>';
                html += '<div class="cp-stock">' + (isZero ? 'Sin stock' : cm.avail + ' uds') + '</div>';
                html += '</div>';
            });
            
            $('colorPhotoGrid').innerHTML = html;
            $('colorPhotoOverlay').classList.add('show');
        }
        
        function closeColorPhotoOverlay() {
            $('colorPhotoOverlay').classList.remove('show');
        }
        
        function selectColorFromOverlay(color) {
            state.color = (state.color === color) ? '' : color;
            articleColorFilter = state.color;
            closeColorPhotoOverlay();
            applyFilters();
        }
        
        // ===== IMAGES =====
        function getProductImage(codigo) {
            if (!codigo) return '';
            const url = IMAGES_MAP[codigo] || IMAGES_MAP[String(codigo)] || '';
            return url ? url.replace(/-O\.jpg$/i, '-S.jpg') : '';
        }
        function getProductImageFull(codigo, product) {
            if (!codigo) return '';
            let url = IMAGES_MAP[codigo] || IMAGES_MAP[String(codigo)] || '';
            if (!url && product) {
                const prefix = codigo.replace(/-\d+$/, '');
                for (const key of Object.keys(IMAGES_MAP)) {
                    if (key.startsWith(prefix)) { url = IMAGES_MAP[key]; break; }
                }
            }
            return url || '';
        }
        function showImgModal(codigo) {
            const url = getProductImageFull(codigo);
            if (!url) return;
            $('imgModalSrc').src = url; $('imgModal').classList.add('show');
        }
        function closeImgModal() { $('imgModal').classList.remove('show'); $('imgModalSrc').src = ''; }
        
        // ===== ARTICLE DETAIL VIEW =====
        function isArticleDetailMode() {
            return state.searchExact && state.search.length > 0 && !forceListView;
        }
        
        function renderArticleDetail() {
            const products = state.filtered;
            if (!products.length) {
                $('articleDetailContent').innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div>No hay variantes</div></div>';
                $('articleStickyName').textContent = state.search.toUpperCase();
                $('articleDetailView').classList.add('active');
                $('productList').style.display = 'none'; $('pagination').style.display = 'none';
                return;
            }
            
            const articleName = products[0].titulo || products[0].articulo || state.search;
            $('articleStickyName').textContent = articleName.toUpperCase();
            $('articleDetailView').classList.add('active');
            $('productList').style.display = 'none'; $('pagination').style.display = 'none';
            
            const allProducts = [...products];
            const colorGroups = {};
            allProducts.forEach(p => {
                const c = p.color || 'Sin color';
                if (!colorGroups[c]) colorGroups[c] = [];
                colorGroups[c].push(p);
            });
            
            let totalStock = 0, totalCartQty = 0;
            allProducts.forEach(p => { totalStock += p.stock || 0; totalCartQty += getCartQty(p.id); });
            const totalAvail = totalStock - totalCartQty;
            
            let html = '';
            html += '<div class="article-stats-row">' +
                '<span>üì¶ <strong>' + allProducts.length + '</strong> var.</span>' +
                '<span>üìä <strong>' + totalAvail + '</strong>/' + totalStock + '</span>' +
                (totalCartQty ? '<span style="color:var(--success)">üõí ' + totalCartQty + '</span>' : '') +
                '<button class="article-photo-toggle" id="articlePhotoToggle" onclick="toggleArticlePhotos()">üì∑</button>' +
                '<button class="article-photo-toggle" onclick="switchToListView()">üìù</button>' +
                '</div>';
            
            // Build color meta
            const colorNames = Object.keys(colorGroups).sort();
            const colorMeta = {};
            colorNames.forEach(color => {
                const prods = colorGroups[color];
                let cStock = 0, cCart = 0, imgUrl = '';
                prods.forEach(p => { cStock += p.stock || 0; cCart += getCartQty(p.id); });
                for (const p of prods) { imgUrl = getProductImageFull(p.codigo, p); if (imgUrl) break; }
                colorMeta[color] = { stock: cStock, cart: cCart, avail: cStock - cCart, imgUrl };
            });
            
            // Filter colors if selected
            const visibleColors = colorNames;
            
            visibleColors.forEach(color => {
                const prods = colorGroups[color];
                prods.sort((a, b) => {
                    const sa = a.talle || '', sb = b.talle || '';
                    const na = parseFloat(sa), nb = parseFloat(sb);
                    if (!isNaN(na) && !isNaN(nb)) return na - nb;
                    const ia = SIZE_ORDER.indexOf(sa.toUpperCase()), ib = SIZE_ORDER.indexOf(sb.toUpperCase());
                    if (ia > -1 && ib > -1) return ia - ib;
                    return sa.localeCompare(sb);
                });
                
                const cm = colorMeta[color];
                const colorAvail = cm.avail;
                const colorStock = cm.stock;
                const colorCart = cm.cart;
                const colorIsZero = colorAvail <= 0;
                
                let colorImgUrl = cm.imgUrl;
                
                html += '<div class="article-color-section">';
                html += '<div class="article-color-sticky' + (colorIsZero ? '" style="opacity:0.5;border-bottom-color:var(--danger)"' : '"') + '>üé® ' + color + 
                    (colorIsZero ? ' <span style="color:var(--danger);font-size:0.75em">‚úó</span>' : '') +
                    '<span class="color-stock-badge">' + colorAvail + '/' + colorStock + (colorCart ? ' üõí' + colorCart : '') + '</span></div>';
                
                if (colorImgUrl) {
                    html += '<img class="article-color-img" src="' + colorImgUrl + '" onclick="showImgModal(\'' + prods[0].codigo + '\')" onerror="this.remove()">';
                }
                
                html += '<div class="article-sizes-grid">';
                prods.forEach(p => {
                    const cartQty = getCartQty(p.id);
                    const inCart = cartQty > 0;
                    const available = p.stock - cartQty;
                    const stockClass = available > 5 ? 'high' : available > 0 ? 'med' : 'low';
                    const isZero = available <= 0 && cartQty === 0;
                    const isSelected = articleSelectedId === p.id;
                    
                    html += '<div class="article-size-cell' + 
                        (isZero ? ' zero' : '') + 
                        (inCart ? ' in-cart' : '') +
                        (isSelected ? ' selected' : '') + 
                        '" data-pid="' + p.id + '" onclick="articleTapSize(' + p.id + ')">' +
                        (inCart ? '<span class="asc-cart-badge">' + cartQty + '</span>' : '') +
                        '<div class="asc-size">' + (p.talle || '-') + '</div>' +
                        '<div class="asc-stock ' + stockClass + '">' + available + '</div>' +
                        '</div>';
                });
                html += '</div></div>';
            });
            
            $('showingCount').textContent = allProducts.length;
            $('totalCount').textContent = allProducts.length;
            $('articleDetailContent').innerHTML = html;
        }
        
        function hideArticleDetail() {
            $('articleDetailView').classList.remove('active');
            $('articleDetailView').classList.remove('show-photos');
            $('productList').style.display = '';
            $('pagination').style.display = '';
            $('articleEditBar').classList.remove('show');
            articleSelectedId = null;
            articleColorFilter = '';
            showColorStrip = false;
        }
        
        function toggleArticlePhotos() {
            const view = $('articleDetailView');
            view.classList.toggle('show-photos');
            const btn = $('articlePhotoToggle');
            if (btn) btn.classList.toggle('active', view.classList.contains('show-photos'));
        }
        
        function toggleColorStrip() { openColorPhotoOverlay(); }
        
        function filterArticleColor(color) {
            articleColorFilter = color;
            state.color = color;
            applyFilters();
        }
        
        function switchToListView() { forceListView = true; hideArticleDetail(); render(); }
        function switchToDetailView() { forceListView = false; render(); }
        
        // Tap size cell = add 1 to cart + select
        function articleTapSize(productId) {
            const p = PRODUCTS.find(x => x.id === productId);
            if (!p) return;
            
            const currentQty = getCartQty(productId);
            const available = p.stock - currentQty;
            
            if (articleSelectedId === productId) {
                // Already selected ‚Äî add 1 more
                if (available <= 0) {
                    // Exceeding stock ‚Äî ask confirmation
                    if (!confirm('‚ö†Ô∏è Sin stock disponible (' + p.stock + ' en sistema, ' + currentQty + ' en carrito).\n¬øAgregar igual?')) return;
                }
                const existing = state.cart.find(c => c.id === productId);
                if (existing) { existing.qty += 1; }
                else { state.cart.push({ ...p, qty: 1 }); }
                saveCart(); updateBadge();
                const qty = getCartQty(productId);
                toast('üõí ' + qty + '  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success');
            } else {
                // First tap ‚Äî select
                articleSelectedId = productId;
                const existing = state.cart.find(c => c.id === productId);
                if (!existing) {
                    // Add 1 if not in cart
                    if (p.stock === 0) {
                        if (!confirm('‚ö†Ô∏è Sin stock. ¬øAgregar igual?')) { articleUpdateEditBar(); renderArticleDetail(); return; }
                    }
                    state.cart.push({ ...p, qty: 1 });
                    saveCart(); updateBadge();
                    toast('‚úì Agregado  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success');
                }
            }
            articleUpdateEditBar();
            renderArticleDetail();
        }
        
        function articleUpdateEditBar() {
            if (!articleSelectedId) { $('articleEditBar').classList.remove('show'); return; }
            const product = PRODUCTS.find(p => p.id === articleSelectedId);
            if (!product) return;
            const qty = getCartQty(articleSelectedId);
            const avail = product.stock - qty;
            $('articleEditLabel').textContent = 'üé® ' + (product.color || '-') + '  ¬∑  Talle ' + (product.talle || '-') + '  ¬∑  Disp: ' + avail + '/' + product.stock;
            $('articleEditVal').textContent = qty;
            $('articleEditVal').style.color = qty > 0 ? 'var(--success)' : 'var(--text-secondary)';
            $('articleManualInput').value = '';
            $('articleEditBar').classList.add('show');
        }
        
        function closeEditBar() {
            $('articleEditBar').classList.remove('show');
            articleSelectedId = null;
            renderArticleDetail();
        }
        
        function articleChangeQty(delta) {
            if (!articleSelectedId) return;
            const p = PRODUCTS.find(x => x.id === articleSelectedId);
            if (!p) return;
            const currentQty = getCartQty(articleSelectedId);
            const newQty = currentQty + delta;
            
            // Warn if exceeding stock
            if (delta > 0 && newQty > p.stock) {
                if (!confirm('‚ö†Ô∏è Super√°s el stock (' + p.stock + ').\n¬øAgregar igual?')) return;
            }
            
            if (newQty <= 0) {
                const idx = state.cart.findIndex(c => c.id === articleSelectedId);
                if (idx >= 0) state.cart.splice(idx, 1);
                toast('‚úó Quitado  ' + (p.color || '') + ' T:' + (p.talle || ''));
            } else if (currentQty === 0 && delta > 0) {
                state.cart.push({ ...p, qty: newQty });
                toast('üõí ' + newQty + '  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success');
            } else {
                const idx = state.cart.findIndex(c => c.id === articleSelectedId);
                if (idx >= 0) state.cart[idx].qty = newQty;
                toast('üõí ' + newQty + '  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success');
            }
            saveCart(); updateBadge();
            articleUpdateEditBar();
            renderArticleDetail();
        }
        
        function articleSetManual() {
            if (!articleSelectedId) return;
            const p = PRODUCTS.find(x => x.id === articleSelectedId);
            if (!p) return;
            const value = parseInt($('articleManualInput').value);
            if (isNaN(value) || value < 0) { toast('‚ö†Ô∏è Cantidad inv√°lida', 'warning'); return; }
            
            const idx = state.cart.findIndex(c => c.id === articleSelectedId);
            if (value === 0) {
                if (idx >= 0) state.cart.splice(idx, 1);
                toast('‚úó Quitado  ' + (p.color || '') + ' T:' + (p.talle || ''));
            } else if (idx >= 0) {
                state.cart[idx].qty = value;
                toast('üõí ' + value + '  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success');
            } else {
                state.cart.push({ ...p, qty: value });
                toast('üõí ' + value + '  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success');
            }
            $('articleManualInput').value = '';
            saveCart(); updateBadge();
            articleUpdateEditBar();
            renderArticleDetail();
        }
        
        // ===== RENDER =====
        function render() {
            if (isArticleDetailMode()) { renderArticleDetail(); updateBadge(); return; }
            hideArticleDetail();
            
            const start = (state.page - 1) * state.pageSize;
            const items = state.filtered.slice(start, start + state.pageSize);
            const totalPages = Math.ceil(state.filtered.length / state.pageSize);
            
            $('showingCount').textContent = Math.min(start + state.pageSize, state.filtered.length);
            $('totalCount').textContent = state.filtered.length.toLocaleString();
            
            if (!items.length) {
                $('productList').innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div>No se encontraron productos</div></div>';
                $('pagination').innerHTML = '';
                return;
            }
            
            let html = '';
            let lastColor = null;
            
            if (forceListView && state.searchExact && state.search) {
                html += '<div style="padding:8px;text-align:center;background:var(--bg-input);border-radius:8px;margin-bottom:2px;cursor:pointer;font-size:0.78em;font-weight:600;color:var(--primary);" onclick="switchToDetailView()">üìä Volver a vista detalle</div>';
            }
            
            items.forEach(p => {
                if (p.color !== lastColor) {
                    html += '<div class="color-divider">üé® ' + (p.color || 'Sin color') + '</div>';
                    lastColor = p.color;
                }
                const cartQty = getCartQty(p.id);
                const inCart = cartQty > 0;
                const availableStock = p.stock - cartQty;
                const stockClass = p.stock > 5 ? 'high' : p.stock > 0 ? 'med' : 'low';
                const noStock = p.stock === 0;
                
                let qtyHtml = inCart
                    ? '<div class="qty-control"><button class="qty-btn" onclick="changeQty(' + p.id + ',-1,event)">‚àí</button><span class="qty-val">' + cartQty + '</span><button class="qty-btn" onclick="changeQty(' + p.id + ',1,event)">+</button></div>'
                    : '<button class="btn-add' + (noStock ? ' no-stock' : '') + '" onclick="listAddToCart(' + p.id + ',' + noStock + ',event)">+</button>';
                
                let stockDisplay = '<div class="stock-num ' + stockClass + '">' + p.stock + '</div><div class="stock-label">stock</div>';
                if (inCart) stockDisplay += '<div class="stock-remaining" style="color:var(--success)">üõí ' + cartQty + '</div>';
                
                const imgUrl = getProductImage(p.codigo);
                const thumbHtml = imgUrl 
                    ? '<img class="product-thumb" loading="lazy" src="' + imgUrl + '" onclick="showImgModal(\'' + p.codigo + '\')" onerror="this.outerHTML=\'<div class=product-thumb-placeholder>üì¶</div>\'">'
                    : '<div class="product-thumb-placeholder">üì¶</div>';
                
                let skuParts = [];
                if (settings.showSku) skuParts.push('SKU: ' + p.codigo);
                if (settings.showUbic && p.ubicacion) skuParts.push('üìç ' + p.ubicacion);
                const skuHtml = skuParts.length ? '<div class="product-sku">' + skuParts.join(' | ') + '</div>' : '';
                
                html += '<div class="product-item' + (inCart ? ' in-cart' : '') + (noStock ? ' no-stock' : '') + '">' +
                    thumbHtml +
                    '<div class="product-info">' +
                    '<div class="product-meta">' + (p.color || '-') + ' ‚Ä¢ T:' + (p.talle || '-') + '</div>' +
                    skuHtml +
                    '<div class="product-name" onclick="searchArticle(\'' + (p.titulo || p.articulo || '').replace(/'/g, "\\'") + '\')">' + (p.titulo || p.articulo || '-') + '</div></div>' +
                    '<div class="product-right"><div class="product-stock">' + stockDisplay + '</div>' + qtyHtml + '</div></div>';
            });
            
            $('productList').innerHTML = html;
            if (state.showImages) $('productList').classList.add('show-images');
            else $('productList').classList.remove('show-images');
            
            if (totalPages > 1) {
                let h = '<button class="page-btn" onclick="goPage(' + (state.page - 1) + ')"' + (state.page === 1 ? ' disabled' : '') + '>‚Äπ</button>';
                for (let i = Math.max(1, state.page - 2); i <= Math.min(totalPages, state.page + 2); i++) {
                    h += '<button class="page-btn' + (i === state.page ? ' active' : '') + '" onclick="goPage(' + i + ')">' + i + '</button>';
                }
                h += '<button class="page-btn" onclick="goPage(' + (state.page + 1) + ')"' + (state.page === totalPages ? ' disabled' : '') + '>‚Ä∫</button>';
                $('pagination').innerHTML = h;
            } else { $('pagination').innerHTML = ''; }
        }
        
        function listAddToCart(id, noStock, e) {
            e.stopPropagation();
            const p = addToCart(id, noStock);
            if (p) { toast('‚úì Agregado  ' + (p.color || '') + ' T:' + (p.talle || ''), 'success'); render(); }
        }
        
        function goPage(p) {
            const max = Math.ceil(state.filtered.length / state.pageSize);
            if (p < 1 || p > max) return;
            state.page = p; render(); window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ===== EXPORT FUNCTIONS =====
        function validateForm() {
            if (state.orderType === 'reposicion') return true;
            if (state.orderType === 'pedido') {
                const clientName = $('clientName').value.trim();
                if (!clientName) {
                    $('clientName').classList.add('error'); $('clientName').focus();
                    setTimeout(() => $('clientName').classList.remove('error'), 500);
                    showModal('üë§', 'Nombre requerido', 'Ingresa el nombre del cliente.', 'Entendido', null);
                    return false;
                }
                const paymentStatus = document.querySelector('input[name="payment"]:checked')?.value;
                if (paymentStatus === 'pendiente') {
                    const paymentAmount = $('paymentAmount').value.trim();
                    if (!paymentAmount) {
                        $('paymentAmount').classList.add('error'); $('paymentAmount').focus();
                        setTimeout(() => $('paymentAmount').classList.remove('error'), 500);
                        showModal('üí∞', 'Monto requerido', 'Ingresa el monto a abonar.', 'Entendido', null);
                        return false;
                    }
                }
            }
            return true;
        }
        
        function getOrderInfo() {
            const clientName = $('clientName').value.trim() || 'Sin nombre';
            const deliveryType = document.querySelector('input[name="delivery"]:checked')?.value || 'local';
            const shippingAddress = $('shippingAddress').value.trim();
            const paymentStatus = document.querySelector('input[name="payment"]:checked')?.value || 'abonado';
            const paymentAmount = $('paymentAmount').value.trim();
            let deliveryText = deliveryType === 'local' ? 'üè™ Local (Galer√≠a)' : deliveryType === 'deposito' ? 'üì¶ Dep√≥sito Mikra' : 'üöö Env√≠o';
            let paymentText = paymentStatus === 'abonado' ? '‚úÖ Ya abon√≥' : '‚è≥ Falta: ' + (paymentAmount || 'Sin especificar');
            return { clientName, deliveryType, deliveryText, shippingAddress, paymentStatus, paymentText, paymentAmount };
        }
        
        function shareWhatsApp() {
            if (!state.cart.length) return;
            if (!validateForm()) return;
            let text = '';
            if (state.orderType === 'reposicion') { text = 'üîÑ REPOSICI√ìN GALER√çA\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n'; }
            else if (state.orderType === 'presupuesto') { text = 'üí∞ PRESUPUESTO MIKRA\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n'; }
            else {
                const order = getOrderInfo();
                text = 'üìã PEDIDO MIKRA\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                text += 'üë§ ' + order.clientName + '\nüìç ' + order.deliveryText + '\n';
                if (order.deliveryType === 'envio' && order.shippingAddress) text += 'üì¨ ' + order.shippingAddress + '\n';
                text += 'üí≥ ' + order.paymentText + '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
            }
            state.cart.forEach(p => { text += p.qty + ' - \t' + (p.titulo || p.articulo) + ', ' + (p.color || '-') + ', T:' + (p.talle || '-') + '\n'; });
            text += '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nTOTAL: ' + state.cart.reduce((a, p) => a + p.qty, 0) + ' uds\n';
            if (state.orderType === 'presupuesto') {
                let total = 0;
                const grouped = {};
                state.cart.forEach(p => { const n = p.titulo || p.articulo; if (!grouped[n]) grouped[n] = { qty: 0, price: articlePrices[n] || 0 }; grouped[n].qty += p.qty; });
                Object.entries(grouped).forEach(([n, d]) => { if (d.price > 0) { text += n + ' x' + d.qty + ' = $' + (d.qty * d.price).toLocaleString() + '\n'; total += d.qty * d.price; } });
                text += '\nüí∞ TOTAL: $' + total.toLocaleString() + '\n';
            }
            text += '\nC√ìDIGOS:\n';
            state.cart.forEach(p => { text += p.codigo + '\t-' + p.qty + '\n'; });
            window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
            askClearCart();
        }
        
        function downloadPDF() {
            if (!state.cart.length || !validateForm()) return;
            const date = new Date().toLocaleDateString('es-AR');
            const total = state.cart.reduce((a, p) => a + p.qty, 0);
            let title = state.orderType === 'reposicion' ? 'Reposici√≥n Galer√≠a' : state.orderType === 'presupuesto' ? 'Presupuesto Mikra' : 'Pedido Mikra';
            let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + title + '</title>' +
                '<style>body{font-family:Arial,sans-serif;padding:20px}h1{color:#1a2744;font-size:18px;margin-bottom:5px;font-weight:bold}' +
                '.info{background:#f5f5f5;padding:10px;border-radius:8px;margin:10px 0;font-weight:bold}' +
                'table{width:100%;border-collapse:collapse;margin-top:15px;font-size:12px}' +
                'th,td{border:1px solid #ccc;padding:8px;text-align:left;font-weight:bold}th{background:#1a2744;color:white}' +
                '.total{margin-top:15px;font-weight:bold;font-size:14px}</style></head><body>' +
                '<h1>' + title + '</h1><div style="color:#666;font-size:12px;font-weight:bold">Fecha: ' + date + '</div>';
            if (state.orderType === 'pedido') {
                const order = getOrderInfo();
                html += '<div class="info"><strong>Cliente:</strong> ' + order.clientName + '<br>' +
                    '<strong>Entrega:</strong> ' + order.deliveryText + '<br>';
                if (order.deliveryType === 'envio' && order.shippingAddress) html += '<strong>Direcci√≥n:</strong><br>' + order.shippingAddress.replace(/\n/g, '<br>') + '<br>';
                html += '<strong>Pago:</strong> ' + order.paymentText + '</div>';
            }
            html += '<table><thead><tr><th>C√≥digo</th><th>Cant.</th><th>Producto</th><th>Color</th><th>Talle</th>';
            if (state.orderType === 'presupuesto') html += '<th>Precio</th><th>Subtotal</th>';
            html += '</tr></thead><tbody>';
            let grandTotal = 0;
            state.cart.forEach(p => {
                const name = p.titulo || p.articulo;
                const price = articlePrices[name] || 0;
                const subtotal = p.qty * price; grandTotal += subtotal;
                html += '<tr><td>' + p.codigo + '</td><td>' + p.qty + '</td><td>' + name + '</td><td>' + (p.color || '-') + '</td><td>' + (p.talle || '-') + '</td>';
                if (state.orderType === 'presupuesto') html += '<td>$' + price.toLocaleString() + '</td><td>$' + subtotal.toLocaleString() + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table><div class="total">Total: ' + total + ' unidades';
            if (state.orderType === 'presupuesto') html += '<br>üí∞ TOTAL: $' + grandTotal.toLocaleString();
            html += '</div></body></html>';
            const win = window.open('', '_blank'); win.document.write(html); win.document.close(); win.print();
            askClearCart();
        }
        
        function downloadTicket() {
            if (!state.cart.length || !validateForm()) return;
            $('ticketTypeModal').classList.add('show');
        }
        function closeTicketTypeModal() { $('ticketTypeModal').classList.remove('show'); }
        
        function downloadTicketDetalle() {
            if (!state.cart.length || !validateForm()) return;
            const date = new Date().toLocaleDateString('es-AR');
            const time = new Date().toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
            const total = state.cart.reduce((a, p) => a + p.qty, 0);
            let title = state.orderType === 'reposicion' ? 'REPOSICI√ìN' : state.orderType === 'presupuesto' ? 'PRESUPUESTO' : 'PEDIDO';
            let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Ticket</title>' +
                '<style>' +
                '@page{size:70mm auto;margin:0}' +
                '*{margin:0;padding:0;box-sizing:border-box}' +
                'body{font-family:"Courier New",Courier,monospace;width:62mm;margin:3mm 4mm;font-size:13px;font-weight:900;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}' +
                '.center{text-align:center}' +
                '.title{font-size:20px;font-weight:900;letter-spacing:2px;margin:4px 0 2px}' +
                '.subtitle{font-size:15px;font-weight:900;margin-bottom:2px}' +
                '.line{border-top:2px dashed #000;margin:6px 0}' +
                '.row{display:flex;justify-content:space-between;margin:2px 0;font-weight:900;font-size:12px}' +
                '.item{margin:4px 0;padding:3px 0;border-bottom:2px dotted #000}' +
                '.item-name{font-weight:900;font-size:13px}' +
                '.item-detail{font-size:11px;font-weight:900;color:#000;margin-top:1px}' +
                '.total-row{font-size:16px;font-weight:900;margin-top:6px}' +
                '.footer{font-size:10px;font-weight:900;text-align:center;margin-top:10px}' +
                '</style></head><body>';
            html += '<div class="center"><div class="title">MIKRA</div></div>';
            html += '<div class="center subtitle">' + title + '</div><div class="line"></div>';
            html += '<div class="row"><span>Fecha:</span><span>' + date + ' ' + time + '</span></div>';
            if (state.orderType === 'pedido') {
                const order = getOrderInfo();
                html += '<div class="row"><span>Cliente:</span><span>' + order.clientName + '</span></div>';
                html += '<div class="row"><span>Entrega:</span><span>' + (order.deliveryType === 'local' ? 'Local' : order.deliveryType === 'deposito' ? 'Dep√≥sito' : 'Env√≠o') + '</span></div>';
                html += '<div class="row"><span>Pago:</span><span>' + (order.paymentStatus === 'abonado' ? 'Abonado' : 'Pendiente') + '</span></div>';
                if (order.paymentStatus === 'pendiente' && order.paymentAmount) html += '<div class="row"><span>Monto:</span><span>' + order.paymentAmount + '</span></div>';
            }
            html += '<div class="line"></div><div class="center" style="font-size:13px;font-weight:900;letter-spacing:1px">‚îÄ‚îÄ DETALLE ‚îÄ‚îÄ</div><div class="line"></div>';
            state.cart.forEach(p => {
                const name = p.titulo || p.articulo;
                html += '<div class="item"><div class="item-name">' + p.qty + 'x ' + name + '</div>';
                html += '<div class="item-detail">' + (p.color || '-') + ' | T:' + (p.talle || '-') + ' | ' + p.codigo + '</div>';
                if (state.orderType === 'presupuesto' && articlePrices[name]) {
                    html += '<div class="row"><span>$' + articlePrices[name].toLocaleString() + ' c/u</span><span>$' + (p.qty * articlePrices[name]).toLocaleString() + '</span></div>';
                }
                html += '</div>';
            });
            html += '<div class="line"></div><div class="total-row row"><span>TOTAL UNIDADES:</span><span>' + total + '</span></div>';
            if (state.orderType === 'presupuesto') {
                let gt = 0; state.cart.forEach(p => { gt += p.qty * (articlePrices[p.titulo || p.articulo] || 0); });
                html += '<div class="total-row row"><span>TOTAL $:</span><span>$' + gt.toLocaleString() + '</span></div>';
            }
            html += '<div class="line"></div><div class="footer">Gracias por su compra!<br>www.mikra.com.ar</div></body></html>';
            const win = window.open('', '_blank'); win.document.write(html); win.document.close(); win.print();
            askClearCart();
        }
        
        function downloadTicketPreparados(mode) {
            if (!state.cart.length) return;
            const date = new Date().toLocaleDateString('es-AR');
            const time = new Date().toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
            const SO = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL'];
            
            function sizeIndex(s) {
                const u = (s || '').toUpperCase();
                const n = parseFloat(u);
                if (!isNaN(n)) return 1000 + n;
                const i = SO.indexOf(u);
                return i > -1 ? i : 500;
            }
            
            // Group by article ‚Üí color ‚Üí sizes
            const articles = {};
            state.cart.forEach(p => {
                const artName = p.titulo || p.articulo || 'Sin nombre';
                const color = p.color || 'Sin color';
                if (!articles[artName]) articles[artName] = {};
                if (!articles[artName][color]) articles[artName][color] = {};
                const talle = p.talle || '-';
                articles[artName][color][talle] = (articles[artName][color][talle] || 0) + p.qty;
            });
            
            const sortedArticles = Object.keys(articles).sort((a, b) => a.localeCompare(b, 'es'));
            
            let grandTotal = 0;
            
            let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Preparados</title>' +
                '<style>' +
                '@page{size:70mm auto;margin:0}' +
                '*{margin:0;padding:0;box-sizing:border-box}' +
                'body{font-family:"Courier New",Courier,monospace;width:62mm;margin:3mm 4mm;font-size:14px;font-weight:900;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}' +
                '.center{text-align:center}' +
                '.title{font-size:20px;font-weight:900;letter-spacing:2px;margin:4px 0 2px}' +
                '.subtitle{font-size:15px;font-weight:900;margin-bottom:2px}' +
                '.line{border-top:2px dashed #000;margin:6px 0}' +
                '.line-thick{border-top:3px solid #000;margin:8px 0}' +
                '.art-name{font-size:14px;font-weight:900;text-transform:uppercase;background:#000;color:#fff;text-align:center;margin:0 -4mm;padding:5px 4mm;word-wrap:break-word;line-height:1.3}' +
                '.color-block{padding:4px 0}' +
                '.color-name{font-size:14px;font-weight:900;margin-bottom:3px}' +
                '.sizes-row{display:flex;gap:0}' +
                '.size-cell{flex:1;text-align:center;border:2px solid #000;border-radius:3px;margin:0 1px;padding:1px 0}' +
                '.size-cell .lbl{font-size:10px;font-weight:900;border-bottom:1px solid #000;padding-bottom:1px;margin-bottom:1px}' +
                '.size-cell .qty{font-size:20px;font-weight:900;line-height:1.2}' +
                '.size-cell.empty{border-color:#ccc}' +
                '.size-cell.tot{max-width:30px;border:none;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center}' +
                '.sep{border-top:1px dashed #999;margin:3px 0}' +
                '.grand{font-size:18px;font-weight:900;display:flex;justify-content:space-between;margin-top:8px;padding-top:4px}' +
                '</style></head><body>';
            
            html += '<div class="center"><div class="title">MIKRA</div></div>';
            html += '<div class="center subtitle">PREPARADOS</div>';
            html += '<div style="text-align:center;font-size:12px;font-weight:900">' + date + ' ' + time + '</div>';
            
            if (state.orderType === 'pedido') {
                const cn = $('clientName').value.trim();
                if (cn) html += '<div style="text-align:center;font-size:13px;font-weight:900;margin-top:3px">' + cn + '</div>';
            }
            
            html += '<div class="line-thick"></div>';
            
            sortedArticles.forEach(artName => {
                const colors = articles[artName];
                
                // Collect ALL sizes for this article across all colors
                const allSizesSet = new Set();
                Object.values(colors).forEach(sizeMap => {
                    Object.keys(sizeMap).forEach(s => allSizesSet.add(s));
                });
                const allSizes = Array.from(allSizesSet).sort((a, b) => sizeIndex(a) - sizeIndex(b));
                
                html += '<div class="art-name">' + artName + '</div>';
                
                const sortedColors = Object.keys(colors).sort((a, b) => a.localeCompare(b, 'es'));
                
                sortedColors.forEach((color, ci) => {
                    const sizeMap = colors[color];
                    
                    let colorTotal = 0;
                    Object.values(sizeMap).forEach(q => colorTotal += q);
                    grandTotal += colorTotal;
                    
                    html += '<div class="color-block">';
                    html += '<div class="color-name">' + color + '</div>';
                    html += '<div class="sizes-row">';
                    allSizes.forEach(s => {
                        if (sizeMap[s]) {
                            html += '<div class="size-cell"><div class="lbl">' + s + '</div><div class="qty">' + sizeMap[s] + '</div></div>';
                        } else {
                            html += '<div class="size-cell empty"></div>';
                        }
                    });
                    html += '<div class="size-cell tot">' + colorTotal + '</div>';
                    html += '</div>';
                    html += '</div>';
                    if (ci < sortedColors.length - 1) html += '<div class="sep"></div>';
                });
                
                html += '<div class="line"></div>';
            });
            
            html += '<div class="line-thick"></div>';
            html += '<div class="grand"><span>TOTAL:</span><span>' + grandTotal + ' uds</span></div>';
            html += '</body></html>';
            
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            if (mode === 'print') {
                win.print();
                askClearCart();
            }
        }
        
        function showPreparadosOptions() { $('preparadosOptModal').classList.add('show'); }
        function closePreparadosOpt() { $('preparadosOptModal').classList.remove('show'); }
        
        function downloadPreparacion() {
            if (!state.cart.length) return;
            const date = new Date().toLocaleDateString('es-AR');
            let clientName = '';
            if (state.orderType === 'pedido') clientName = $('clientName').value.trim();
            
            // Group cart by article then by color
            const articles = {};
            state.cart.forEach(p => {
                const artName = p.titulo || p.articulo || 'Sin nombre';
                if (!articles[artName]) articles[artName] = {};
                const color = p.color || 'Sin color';
                if (!articles[artName][color]) articles[artName][color] = { items: [], imgUrl: '' };
                articles[artName][color].items.push(p);
                if (!articles[artName][color].imgUrl) {
                    articles[artName][color].imgUrl = getProductImageFull(p.codigo, p);
                }
            });
            
            let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Preparaci√≥n</title>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; padding: 15px; font-size: 13px; }' +
                'h1 { font-size: 18px; color: #1a2744; margin-bottom: 3px; }' +
                '.subtitle { font-size: 12px; color: #666; margin-bottom: 15px; }' +
                '.article-title { background: #1a2744; color: white; padding: 8px 14px; font-size: 14px; font-weight: bold; margin-top: 12px; border-radius: 6px 6px 0 0; page-break-inside: avoid; }' +
                '.color-row { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border: 1px solid #ddd; border-top: none; page-break-inside: avoid; min-height: 80px; }' +
                '.color-row:last-child { border-radius: 0 0 6px 6px; }' +
                '.color-img { width: 90px; height: 90px; object-fit: cover; border-radius: 6px; border: 1px solid #ccc; flex-shrink: 0; }' +
                '.no-img { width: 90px; height: 40px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; flex-shrink: 0; }' +
                '.color-info { flex: 1; }' +
                '.color-name { font-weight: bold; font-size: 14px; color: #1a2744; margin-bottom: 6px; }' +
                '.sizes-table { display: flex; gap: 6px; flex-wrap: wrap; }' +
                '.size-box { text-align: center; border: 2px solid #1a2744; border-radius: 6px; padding: 4px 8px; min-width: 50px; }' +
                '.size-label { font-size: 10px; color: #666; font-weight: bold; }' +
                '.size-qty { font-size: 18px; font-weight: bold; color: #1a2744; }' +
                '.color-total { font-size: 12px; color: #666; margin-top: 4px; }' +
                '.check-box { width: 22px; height: 22px; border: 2px solid #1a2744; border-radius: 4px; flex-shrink: 0; }' +
                '.grand-total { margin-top: 15px; padding: 12px; background: #1a2744; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; text-align: center; }' +
                '@media print { .color-row { break-inside: avoid; } }' +
                '</style></head><body>';
            
            html += '<h1>üì¶ PREPARACI√ìN DE PEDIDO</h1>';
            html += '<div class="subtitle">Fecha: ' + date + (clientName ? ' ¬∑ Cliente: ' + clientName : '') + '</div>';
            
            let grandTotal = 0;
            
            Object.entries(articles).forEach(([artName, colors]) => {
                html += '<div class="article-title">' + artName + '</div>';
                
                Object.entries(colors).forEach(([color, data]) => {
                    let colorTotal = 0;
                    data.items.forEach(p => colorTotal += p.qty);
                    grandTotal += colorTotal;
                    
                    html += '<div class="color-row">';
                    
                    // Checkbox for marking done
                    html += '<div class="check-box"></div>';
                    
                    // Image
                    if (data.imgUrl) {
                        html += '<img class="color-img" src="' + data.imgUrl + '" onerror="this.outerHTML=\'<div class=no-img>Sin img</div>\'">';
                    } else {
                        html += '<div class="no-img">Sin img</div>';
                    }
                    
                    // Color info + sizes
                    html += '<div class="color-info">';
                    html += '<div class="color-name">üé® ' + color + '</div>';
                    html += '<div class="sizes-table">';
                    
                    // Sort sizes
                    data.items.sort((a, b) => {
                        const sa = a.talle || '', sb = b.talle || '';
                        const na = parseFloat(sa), nb = parseFloat(sb);
                        if (!isNaN(na) && !isNaN(nb)) return na - nb;
                        const ia = SIZE_ORDER.indexOf(sa.toUpperCase()), ib = SIZE_ORDER.indexOf(sb.toUpperCase());
                        if (ia > -1 && ib > -1) return ia - ib;
                        return sa.localeCompare(sb);
                    });
                    
                    data.items.forEach(p => {
                        html += '<div class="size-box"><div class="size-label">' + (p.talle || '-') + '</div><div class="size-qty">' + p.qty + '</div></div>';
                    });
                    
                    html += '</div>'; // sizes-table
                    html += '<div class="color-total">Subtotal: ' + colorTotal + ' uds</div>';
                    html += '</div>'; // color-info
                    html += '</div>'; // color-row
                });
            });
            
            html += '<div class="grand-total">TOTAL A PREPARAR: ' + grandTotal + ' unidades</div>';
            html += '</body></html>';
            
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            // Wait for images to load before printing (once only)
            const imgs = win.document.querySelectorAll('img');
            if (imgs.length === 0) { win.print(); return; }
            let loaded = 0, printed = false;
            const doPrint = () => { if (printed) return; printed = true; win.print(); };
            const tryPrint = () => { loaded++; if (loaded >= imgs.length) setTimeout(doPrint, 400); };
            imgs.forEach(img => {
                if (img.complete) tryPrint();
                else { img.onload = tryPrint; img.onerror = tryPrint; }
            });
            setTimeout(doPrint, 5000);
        }
        
        function askClearCart() { setTimeout(() => $('clearModal').classList.add('show'), 600); }
        function closeClearModal() { $('clearModal').classList.remove('show'); }
        function confirmClearCart() { $('clearModal').classList.remove('show'); clearCart(); toast('Carrito vaciado', 'success'); }
        
        function toast(msg, type = '') {
            const t = $('toast'); t.textContent = msg; t.className = 'toast show';
            if (type) t.classList.add(type);
            setTimeout(() => t.className = 'toast', 2000);
        }
        
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            $('page-' + page).classList.add('active');
            document.querySelector('[data-page="' + page + '"]').classList.add('active');
            // Hide edit bar when switching to cart
            if (page === 'cart') { $('articleEditBar').classList.remove('show'); renderCart(); }
            window.scrollTo({ top: 0 });
        }
        
        // ===== EVENT LISTENERS =====
        const debouncedFilter = debounce(() => {
            showAutocomplete(state.search);
            applyFilters();
        }, 120);
        
        $('searchInput').addEventListener('input', e => {
            state.search = e.target.value.trim(); state.searchExact = false; state.color = ''; state.size = '';
            forceListView = false;
            $('searchClear').classList.toggle('show', state.search.length > 0);
            debouncedFilter();
        });
        $('searchInput').addEventListener('focus', () => { if (state.search.length >= 2) showAutocomplete(state.search); });
        $('autocomplete').addEventListener('click', e => {
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                const name = item.dataset.name;
                $('searchInput').value = name; state.search = name; state.searchExact = true;
                forceListView = false; articleColorFilter = ''; showColorStrip = false;
                $('searchClear').classList.add('show'); $('autocomplete').classList.remove('show'); applyFilters();
            }
        });
        document.addEventListener('click', e => { if (!e.target.closest('.search-container')) $('autocomplete').classList.remove('show'); });
        document.querySelectorAll('[data-stock]').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('[data-stock]').forEach(e => e.classList.remove('active'));
                el.classList.add('active'); state.stock = el.dataset.stock; applyFilters();
            });
        });
        $('colorOptions').addEventListener('click', e => { const opt = e.target.closest('[data-color]'); if (opt) { state.color = opt.dataset.color; applyFilters(); } });
        $('sizeOptions').addEventListener('click', e => { const opt = e.target.closest('[data-size]'); if (opt) { state.size = opt.dataset.size; applyFilters(); } });
        document.querySelectorAll('.nav-btn').forEach(btn => { btn.addEventListener('click', () => switchPage(btn.dataset.page)); });
        document.querySelectorAll('.delivery-option[data-delivery]').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.delivery-option[data-delivery]').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected'); opt.querySelector('input').checked = true;
                $('shippingDetails').classList.toggle('show', opt.dataset.delivery === 'envio');
            });
        });
        document.querySelectorAll('.delivery-option[data-payment]').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.delivery-option[data-payment]').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected'); opt.querySelector('input').checked = true;
                $('paymentDetails').classList.toggle('show', opt.dataset.payment === 'pendiente');
            });
        });
        
        // INIT ‚Äî Cache-first: shows cached data instantly, syncs in background
        applySettingsToUI();
        updateBadge();
        loadData();
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log('‚úÖ SW registrado');
                // Chequear actualizaciones cada 5 minutos
                setInterval(() => reg.update(), 5 * 60 * 1000);
                // Cuando detecte un SW nuevo, recargar autom√°ticamente
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated') {
                            console.log('üîÑ Nueva versi√≥n detectada, recargando...');
                            window.location.reload();
                        }
                    });
                });
            })
            .catch(err => console.log('SW error:', err));
    }
    </script>
</body>
</html>
